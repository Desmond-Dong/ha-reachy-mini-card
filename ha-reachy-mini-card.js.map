{"version":3,"file":"ha-reachy-mini-card.js","sources":["src/reachy-mini-3d-card.js"],"sourcesContent":["// Reachy Mini 3D Card - Direct Daemon Connection\n// Version: 2.0.0\n// https://github.com/Desmond-Dong/ha-reachy-mini-card\n\n(function () {\n  'use strict';\n\n  // Ê≥®ÂÜå custom card\n  window.customCards = window.customCards || [];\n  window.customCards.push({\n    type: 'reachy-mini-3d-card',\n    name: 'Reachy Mini 3D Card',\n    description: 'Real-time 3D visualization of Reachy Mini robot',\n    documentationURL: 'https://github.com/Desmond-Dong/ha-reachy-mini-card'\n  });\n\n  // Ë¢´Âä®ÂÖ≥ËäÇÂêçÁß∞Â∏∏Èáè\n  const PASSIVE_JOINT_NAMES = [\n    'passive_1_x', 'passive_1_y', 'passive_1_z',\n    'passive_2_x', 'passive_2_y', 'passive_2_z',\n    'passive_3_x', 'passive_3_y', 'passive_3_z',\n    'passive_4_x', 'passive_4_y', 'passive_4_z',\n    'passive_5_x', 'passive_5_y', 'passive_5_z',\n    'passive_6_x', 'passive_6_y', 'passive_6_z',\n    'passive_7_x', 'passive_7_y', 'passive_7_z',\n  ];\n\n  // ÂõæÂΩ¢ÂåñÈÖçÁΩÆÁºñËæëÂô® - ÂøÖÈ°ªÂú®‰∏ªÂç°‰πãÂâçÂÆö‰πâÂíåÊ≥®ÂÜå\n  class ReachyMini3DCardEditor extends HTMLElement {\n    constructor() {\n      super();\n      this.attachShadow({ mode: 'open' });\n    }\n\n    setConfig(config) {\n      this._config = config;\n      this.render();\n    }\n\n    render() {\n      const config = this._config || {};\n\n      this.shadowRoot.innerHTML = `\n      <style>\n        :host { display: block; }\n        .form-row {\n          display: flex;\n          flex-direction: column;\n          margin-bottom: 12px;\n        }\n        label {\n          font-size: 14px;\n          font-weight: 500;\n          margin-bottom: 4px;\n          color: var(--primary-text-color);\n        }\n        input[type=\"text\"],\n        input[type=\"number\"] {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid var(--primary-color);\n          border-radius: 4px;\n          background: var(--card-background-color);\n          color: var(--primary-text-color);\n          box-sizing: border-box;\n        }\n        input[type=\"text\"]:focus,\n        input[type=\"number\"]:focus {\n          outline: none;\n          border-color: var(--accent-color);\n        }\n        .checkbox-row {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          margin-bottom: 8px;\n        }\n        .checkbox-row input[type=\"checkbox\"] {\n          width: auto;\n          margin: 0;\n        }\n        .checkbox-row label {\n          margin-bottom: 0;\n          flex: 1;\n        }\n        .hint {\n          font-size: 12px;\n          color: var(--secondary-text-color);\n          margin-top: 4px;\n        }\n        .section-title {\n          font-size: 13px;\n          font-weight: 600;\n          color: var(--primary-text-color);\n          margin-top: 16px;\n          margin-bottom: 8px;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n        }\n      </style>\n      \n      <div class=\"section-title\">Connection</div>\n      \n      <div class=\"form-row\">\n        <label for=\"host\">Daemon Host</label>\n        <input\n          id=\"host\"\n          type=\"text\"\n          value=\"${config.daemon_host || 'localhost'}\"\n          placeholder=\"localhost or IP address\"\n        />\n        <div class=\"hint\">Reachy Mini daemon hostname or IP address</div>\n      </div>\n      \n      <div class=\"form-row\">\n        <label for=\"port\">Daemon Port</label>\n        <input\n          id=\"port\"\n          type=\"number\"\n          value=\"${config.daemon_port || 8000}\"\n          placeholder=\"8000\"\n        />\n        <div class=\"hint\">WebSocket port (default: 8000)</div>\n      </div>\n      \n      <div class=\"section-title\">Display</div>\n      \n      <div class=\"form-row\">\n        <label for=\"height\">Card Height (px)</label>\n        <input\n          id=\"height\"\n          type=\"number\"\n          value=\"${config.height || 400}\"\n          placeholder=\"400\"\n        />\n        <div class=\"hint\">Height of the card in pixels</div>\n      </div>\n      \n      <div class=\"form-row\">\n        <label for=\"background\">Background Color</label>\n        <input\n          id=\"background\"\n          type=\"text\"\n          value=\"${config.background_color || '#f5f5f5'}\"\n          placeholder=\"#f5f5f5\"\n        />\n        <div class=\"hint\">Background color (hex code)</div>\n      </div>\n      \n      <div class=\"form-row\">\n        <label for=\"camera_distance\">Camera Distance</label>\n        <input\n          id=\"camera_distance\"\n          type=\"number\"\n          step=\"0.1\"\n          value=\"${config.camera_distance || 0.5}\"\n          placeholder=\"0.5\"\n        />\n        <div class=\"hint\">Initial camera distance (0.2 - 1.5)</div>\n      </div>\n      \n      <div class=\"section-title\">Features</div>\n      \n      <div class=\"checkbox-row\">\n        <input type=\"checkbox\" id=\"enable_passive\" ${config.enable_passive_joints !== false ? 'checked' : ''}>\n        <label for=\"enable_passive\">Enable Passive Joints</label>\n      </div>\n      <div class=\"hint\">Show Stewart platform passive joints (requires daemon support)</div>\n      \n      <div class=\"checkbox-row\">\n        <input type=\"checkbox\" id=\"enable_pose\" ${config.enable_head_pose !== false ? 'checked' : ''}>\n        <label for=\"enable_pose\">Enable Head Pose</label>\n      </div>\n      <div class=\"hint\">Use 4x4 pose matrix for head positioning</div>\n      \n      <div class=\"checkbox-row\">\n        <input type=\"checkbox\" id=\"enable_grid\" ${config.enable_grid !== false ? 'checked' : ''}>\n        <label for=\"enable_grid\">Show Grid</label>\n      </div>\n      <div class=\"hint\">Display ground grid helper</div>\n    `;\n\n      // ÁõëÂê¨ËæìÂÖ•ÂèòÂåñ\n      this.shadowRoot.getElementById('host').addEventListener('change', (e) => {\n        this._config = { ...this._config, daemon_host: e.target.value };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('port').addEventListener('change', (e) => {\n        this._config = { ...this._config, daemon_port: parseInt(e.target.value) };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('height').addEventListener('change', (e) => {\n        this._config = { ...this._config, height: parseInt(e.target.value) };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('background').addEventListener('change', (e) => {\n        this._config = { ...this._config, background_color: e.target.value };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('camera_distance').addEventListener('change', (e) => {\n        this._config = { ...this._config, camera_distance: parseFloat(e.target.value) };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('enable_passive').addEventListener('change', (e) => {\n        this._config = { ...this._config, enable_passive_joints: e.target.checked };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('enable_pose').addEventListener('change', (e) => {\n        this._config = { ...this._config, enable_head_pose: e.target.checked };\n        this.dispatchConfig();\n      });\n\n      this.shadowRoot.getElementById('enable_grid').addEventListener('change', (e) => {\n        this._config = { ...this._config, enable_grid: e.target.checked };\n        this.dispatchConfig();\n      });\n    }\n\n    dispatchConfig() {\n      const event = new CustomEvent('config-changed', {\n        detail: { config: this._config },\n        bubbles: true,\n        composed: true\n      });\n      this.dispatchEvent(event);\n    }\n  }\n\n  // ÂÖàÊ≥®ÂÜåÁºñËæëÂô®\n  customElements.define('reachy-mini-3d-card-editor', ReachyMini3DCardEditor);\n\n  // ‰∏ªÂç°Á±ª\n  class ReachyMini3DCard extends HTMLElement {\n    constructor() {\n      super();\n      this.attachShadow({ mode: 'open' });\n      \n      // ÊÄßËÉΩ‰ºòÂåñÁõ∏ÂÖ≥\n      this._frameCount = 0;\n      this._lastDataVersion = -1;\n      this._robotState = {\n        headJoints: null,\n        headPose: null,\n        passiveJoints: null,\n        antennas: [0, 0],\n        dataVersion: 0\n      };\n      \n      // WebSocket ÈáçËøûÊéßÂà∂\n      this._reconnectAttempts = 0;\n      this._maxReconnectAttempts = 10;\n      this._reconnectDelay = 3000;\n      this._reconnectTimeout = null;\n    }\n\n    static get getConfigElement() {\n      return document.createElement('reachy-mini-3d-card-editor');\n    }\n\n    static getStubConfig() {\n      return {\n        daemon_host: 'localhost',\n        daemon_port: 8000,\n        height: 400,\n        enable_passive_joints: true,\n        enable_head_pose: true,\n        background_color: '#f5f5f5',\n        enable_grid: true,\n        camera_distance: 0.5\n      };\n    }\n\n    setConfig(config) {\n      this._config = {\n        daemon_host: 'localhost',\n        daemon_port: 8000,\n        height: 400,\n        enable_passive_joints: true,\n        enable_head_pose: true,\n        background_color: '#f5f5f5',\n        enable_grid: true,\n        camera_distance: 0.5,\n        ...config\n      };\n    }\n\n    getCardSize() {\n      return this._config.height ? this._config.height / 50 : 8;\n    }\n\n    async connectedCallback() {\n      this.render();\n      await this.init();\n    }\n\n    render() {\n      this.shadowRoot.innerHTML = `\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n          transition: all 0.3s ease;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n        #fps-counter {\n          position: absolute;\n          top: 10px;\n          right: 10px;\n          padding: 4px 8px;\n          border-radius: 12px;\n          font-size: 11px;\n          font-weight: 500;\n          color: white;\n          background: rgba(0, 0, 0, 0.6);\n          z-index: 10;\n        }\n      </style>\n      <ha-card>\n        <div id=\"container\">\n          <div id=\"status\" class=\"connecting\">Connecting...</div>\n          <div id=\"fps-counter\">0 FPS</div>\n          <div id=\"loading\" class=\"loading\">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `;\n    }\n\n    async init() {\n      try {\n        // ÂàùÂßãÂåñ Three.js\n        await this.initThreeJS();\n\n        // ËøûÊé• WebSocket\n        this.connectWebSocket();\n\n        // Âä†ËΩΩÊú∫Âô®‰∫∫Ê®°Âûã\n        await this.loadRobot();\n\n      } catch (err) {\n        console.error('Init error:', err);\n        this.showError(err.message);\n      }\n    }\n\n    async initThreeJS() {\n      const container = this.shadowRoot.querySelector('#container');\n      const canvas = document.createElement('canvas');\n      container.appendChild(canvas);\n\n      // Âä®ÊÄÅÂØºÂÖ• Three.js Âíå‰æùËµñ\n      // ‰ΩøÁî® CDN ‰ª•Á°Æ‰øùÂú® Home Assistant ÁéØÂ¢É‰∏≠Ê≠£Â∏∏Â∑•‰Ωú\n      try {\n        const THREE = await import('https://cdn.jsdelivr.net/npm/three@0.181.0/build/three.module.js');\n        const { OrbitControls } = await import('https://cdn.jsdelivr.net/npm/three@0.181.0/examples/jsm/controls/OrbitControls.js');\n\n        // Three.js ES Ê®°ÂùóÈúÄË¶Å‰ΩøÁî® .default Ëé∑ÂèñÂÆûÈôÖÁöÑ THREE ÂØπË±°\n        this._THREE = THREE.default;\n      } catch (err) {\n        console.error('‚ùå Failed to load Three.js:', err);\n        this.showError('Failed to load 3D library. Please check your internet connection.');\n        throw err;\n      }\n\n      // Âú∫ÊôØ\n      this._scene = new this._THREE.Scene();\n      this._scene.background = new this._THREE.Color(this._config.background_color || '#f5f5f5');\n\n      // Áõ∏Êú∫\n      this._camera = new this._THREE.PerspectiveCamera(\n        50,\n        container.clientWidth / this._config.height,\n        0.01,\n        1000\n      );\n      this._camera.position.set(0.3, 0.3, this._config.camera_distance || 0.5);\n\n      // Ê∏≤ÊüìÂô®\n      this._renderer = new this._THREE.WebGLRenderer({ canvas, antialias: true });\n      this._renderer.setSize(container.clientWidth, this._config.height);\n      this._renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n\n      // ÊéßÂà∂Âô®\n      this._controls = new OrbitControls(this._camera, canvas);\n      this._controls.enableDamping = true;\n      this._controls.dampingFactor = 0.05;\n      this._controls.minDistance = 0.2;\n      this._controls.maxDistance = 1.5;\n\n      // ÁÅØÂÖâ\n      this._scene.add(new this._THREE.AmbientLight(0xffffff, 0.6));\n\n      const directionalLight = new this._THREE.DirectionalLight(0xffffff, 0.8);\n      directionalLight.position.set(1, 1, 1);\n      this._scene.add(directionalLight);\n\n      const backLight = new this._THREE.DirectionalLight(0xffffff, 0.3);\n      backLight.position.set(-1, -1, -1);\n      this._scene.add(backLight);\n\n      // Âú∞Èù¢ÁΩëÊ†º\n      if (this._config.enable_grid !== false) {\n        this._scene.add(new this._THREE.GridHelper(0.4, 20, 0x888888, 0xcccccc));\n      }\n\n      // FPS ËÆ°Êï∞Âô®\n      this._fpsCounter = {\n        frameCount: 0,\n        lastTime: performance.now(),\n        fps: 0\n      };\n\n      // Âä®ÁîªÂæ™ÁéØ\n      const animate = () => {\n        requestAnimationFrame(animate);\n        \n        // FPS ËÆ°ÁÆó\n        this._fpsCounter.frameCount++;\n        const currentTime = performance.now();\n        if (currentTime - this._fpsCounter.lastTime >= 1000) {\n          this._fpsCounter.fps = this._fpsCounter.frameCount;\n          this._fpsCounter.frameCount = 0;\n          this._fpsCounter.lastTime = currentTime;\n          \n          const fpsEl = this.shadowRoot.querySelector('#fps-counter');\n          if (fpsEl) {\n            fpsEl.textContent = `${this._fpsCounter.fps} FPS`;\n          }\n        }\n        \n        this._controls.update();\n        this._renderer.render(this._scene, this._camera);\n      };\n      animate();\n    }\n\n    async loadRobot() {\n      const basePath = this.getBasePath();\n      const { default: URDFLoader } = await import(`${basePath}lib/urdf-loader.js`);\n\n      const loader = new URDFLoader();\n      loader.workingPath = `${basePath}assets/`;\n\n      this._robot = await loader.load(`${basePath}assets/reachy-mini.urdf`);\n      this._scene.add(this._robot);\n\n      // ÂàùÂßãÂåñÊâÄÊúâÂÖ≥ËäÇ‰∏∫Èõ∂\n      this._initializeJoints();\n\n      // ÈöêËóèÂä†ËΩΩÂä®Áîª\n      const loading = this.shadowRoot.querySelector('#loading');\n      if (loading) loading.style.display = 'none';\n    }\n\n    _initializeJoints() {\n      if (!this._robot || !this._robot.joints) return;\n\n      // ÂàùÂßãÂåñ yaw_body\n      if (this._robot.joints['yaw_body']) {\n        this._robot.setJointValue('yaw_body', 0);\n      }\n\n      // ÂàùÂßãÂåñ stewart ÂÖ≥ËäÇ\n      const stewartJoints = ['stewart_1', 'stewart_2', 'stewart_3', 'stewart_4', 'stewart_5', 'stewart_6'];\n      stewartJoints.forEach(jointName => {\n        if (this._robot.joints[jointName]) {\n          this._robot.setJointValue(jointName, 0);\n        }\n      });\n\n      // ÂàùÂßãÂåñË¢´Âä®ÂÖ≥ËäÇ\n      PASSIVE_JOINT_NAMES.forEach(jointName => {\n        if (this._robot.joints[jointName]) {\n          this._robot.setJointValue(jointName, 0);\n        }\n      });\n\n      // ÂàùÂßãÂåñÂ§©Á∫ø\n      ['left_antenna', 'right_antenna'].forEach(jointName => {\n        if (this._robot.joints[jointName]) {\n          this._robot.setJointValue(jointName, 0);\n        }\n      });\n\n      // Âº∫Âà∂Êõ¥Êñ∞Áü©Èòµ\n      this._robot.traverse((child) => {\n        if (child.isObject3D) {\n          child.updateMatrix();\n          child.updateMatrixWorld(true);\n        }\n      });\n    }\n\n    getBasePath() {\n      const scripts = document.getElementsByTagName('script');\n      const src = scripts[scripts.length - 1]?.src || '';\n      return src ? src.substring(0, src.lastIndexOf('/') + 1) : '/hacsfiles/ha-reachy-mini-card/';\n    }\n\n    connectWebSocket() {\n      const { daemon_host, daemon_port } = this._config;\n      \n      // ÊûÑÂª∫ WebSocket URLÔºåÂåÖÂê´ÊâÄÊúâÈúÄË¶ÅÁöÑÂèÇÊï∞\n      let wsUrl = `ws://${daemon_host}:${daemon_port}/api/state/ws/full?frequency=20`;\n      wsUrl += '&with_head_joints=true';\n      wsUrl += '&with_antenna_positions=true';\n      \n      if (this._config.enable_passive_joints !== false) {\n        wsUrl += '&with_passive_joints=true';\n      }\n      \n      if (this._config.enable_head_pose !== false) {\n        wsUrl += '&with_head_pose=true';\n        wsUrl += '&use_pose_matrix=true';\n      }\n\n      console.log('üîå Connecting to WebSocket:', wsUrl);\n\n      this._ws = new WebSocket(wsUrl);\n\n      this._ws.onopen = () => {\n        console.log('‚úÖ WebSocket connected');\n        this._reconnectAttempts = 0;\n        this.updateStatus('connected', 'Connected');\n      };\n\n      this._ws.onmessage = (e) => {\n        try {\n          const data = JSON.parse(e.data);\n          this._processRobotData(data);\n        } catch (err) {\n          console.error('‚ùå Parse error:', err);\n        }\n      };\n\n      this._ws.onerror = (error) => {\n        console.error('‚ùå WebSocket error:', error);\n        this.updateStatus('error', 'Error');\n      };\n\n      this._ws.onclose = () => {\n        console.log('üîå WebSocket closed');\n        this.updateStatus('error', 'Disconnected');\n        \n        // ÈáçËøûÈÄªËæë\n        if (this._reconnectAttempts < this._maxReconnectAttempts) {\n          this._reconnectAttempts++;\n          const delay = Math.min(this._reconnectDelay * Math.pow(1.5, this._reconnectAttempts - 1), 30000);\n          \n          console.log(`üîÑ Reconnecting in ${delay}ms (attempt ${this._reconnectAttempts}/${this._maxReconnectAttempts})`);\n          \n          this._reconnectTimeout = setTimeout(() => {\n            this.connectWebSocket();\n          }, delay);\n        } else {\n          console.error('‚ùå Max reconnection attempts reached');\n          this.updateStatus('error', 'Connection Failed');\n        }\n      };\n    }\n\n    _processRobotData(data) {\n      // ÊèêÂèñ head_joints (7 values)\n      if (data.head_joints && Array.isArray(data.head_joints) && data.head_joints.length === 7) {\n        this._robotState.headJoints = data.head_joints;\n      }\n\n      // ÊèêÂèñ head_pose (4x4 matrix)\n      if (data.head_pose) {\n        const headPoseArray = Array.isArray(data.head_pose) \n          ? data.head_pose \n          : data.head_pose.m;\n        \n        if (headPoseArray && headPoseArray.length === 16) {\n          this._robotState.headPose = headPoseArray;\n        }\n      }\n\n      // ÊèêÂèñÂ§©Á∫ø‰ΩçÁΩÆ\n      if (data.antennas_position && Array.isArray(data.antennas_position) && data.antennas_position.length >= 2) {\n        this._robotState.antennas = data.antennas_position;\n      }\n\n      // ÊèêÂèñË¢´Âä®ÂÖ≥ËäÇ (21 values)\n      if (data.passive_joints && Array.isArray(data.passive_joints) && data.passive_joints.length >= 21) {\n        this._robotState.passiveJoints = data.passive_joints;\n      }\n\n      // Â¢ûÂä†Êï∞ÊçÆÁâàÊú¨Âè∑\n      this._robotState.dataVersion++;\n\n      // Êõ¥Êñ∞Êú∫Âô®‰∫∫\n      this._updateRobot();\n    }\n\n    _updateRobot() {\n      if (!this._robot) return;\n\n      // ÊÄßËÉΩ‰ºòÂåñÔºöÂ∏ßËäÇÊµÅÔºàÊØè3Â∏ßÊõ¥Êñ∞‰∏ÄÊ¨°ÔºåÁ∫¶20HzÔºâ\n      this._frameCount++;\n      if (this._frameCount % 3 !== 0) {\n        return;\n      }\n\n      // ÊÄßËÉΩ‰ºòÂåñÔºöÂ¶ÇÊûúÊï∞ÊçÆÁâàÊú¨Ê≤°ÊúâÂèòÂåñÔºåË∑≥ËøáÊõ¥Êñ∞\n      if (this._robotState.dataVersion === this._lastDataVersion) {\n        return;\n      }\n      this._lastDataVersion = this._robotState.dataVersion;\n\n      // Â∫îÁî® head_joints\n      if (this._robotState.headJoints) {\n        const j = this._robotState.headJoints;\n        \n        if (this._robot.joints['yaw_body']) {\n          this._robot.setJointValue('yaw_body', j[0]);\n        }\n        \n        const stewartJoints = ['stewart_1', 'stewart_2', 'stewart_3', 'stewart_4', 'stewart_5', 'stewart_6'];\n        stewartJoints.forEach((jointName, index) => {\n          if (this._robot.joints[jointName]) {\n            this._robot.setJointValue(jointName, j[index + 1]);\n          }\n        });\n      }\n\n      // Â∫îÁî®Ë¢´Âä®ÂÖ≥ËäÇ\n      if (this._config.enable_passive_joints !== false && this._robotState.passiveJoints) {\n        const passiveArray = this._robotState.passiveJoints;\n        for (let i = 0; i < 21; i++) {\n          const jointName = PASSIVE_JOINT_NAMES[i];\n          if (this._robot.joints[jointName]) {\n            this._robot.setJointValue(jointName, passiveArray[i]);\n          }\n        }\n      }\n\n      // Â∫îÁî®Â§©Á∫ø‰ΩçÁΩÆÔºàÊ≥®ÊÑèÔºöÈúÄË¶ÅÂèçËΩ¨Êò†Â∞ÑÂíåÂÄºÔºâ\n      if (this._robotState.antennas) {\n        const antennas = this._robotState.antennas;\n        \n        // Â∑¶Â§©Á∫øÔºàËßÜËßâ‰∏äÂú®Âè≥‰æßÔºâ\n        if (this._robot.joints['left_antenna']) {\n          this._robot.setJointValue('left_antenna', -antennas[1]);\n        }\n        \n        // Âè≥Â§©Á∫øÔºàËßÜËßâ‰∏äÂú®Â∑¶‰æßÔºâ\n        if (this._robot.joints['right_antenna']) {\n          this._robot.setJointValue('right_antenna', -antennas[0]);\n        }\n      }\n    }\n\n    updateStatus(state, msg) {\n      const el = this.shadowRoot.querySelector('#status');\n      if (el) {\n        el.className = state;\n        el.textContent = msg;\n      }\n    }\n\n    showError(msg) {\n      this.shadowRoot.querySelector('#container').innerHTML = `\n      <div style=\"padding: 20px; color: #f44336;\">Error: ${msg}</div>\n    `;\n    }\n\n    disconnectedCallback() {\n      // Ê∏ÖÁêÜ WebSocket\n      if (this._ws) {\n        this._ws.close();\n        this._ws = null;\n      }\n      \n      // Ê∏ÖÁêÜÈáçËøûË∂ÖÊó∂\n      if (this._reconnectTimeout) {\n        clearTimeout(this._reconnectTimeout);\n        this._reconnectTimeout = null;\n      }\n      \n      // Ê∏ÖÁêÜÊ∏≤ÊüìÂô®\n      if (this._renderer) {\n        this._renderer.dispose();\n        this._renderer = null;\n      }\n      \n      // Ê∏ÖÁêÜÂú∫ÊôØ\n      if (this._scene) {\n        this._scene.clear();\n        this._scene = null;\n      }\n    }\n  }\n\n  customElements.define('reachy-mini-3d-card', ReachyMini3DCard);\n\n})();\n"],"names":["window","customCards","push","type","name","description","documentationURL","PASSIVE_JOINT_NAMES","ReachyMini3DCardEditor","HTMLElement","constructor","super","this","attachShadow","mode","setConfig","config","_config","render","shadowRoot","innerHTML","daemon_host","daemon_port","height","background_color","camera_distance","enable_passive_joints","enable_head_pose","enable_grid","getElementById","addEventListener","e","target","value","dispatchConfig","parseInt","parseFloat","checked","event","CustomEvent","detail","bubbles","composed","dispatchEvent","customElements","define","ReachyMini3DCard","_frameCount","_lastDataVersion","_robotState","headJoints","headPose","passiveJoints","antennas","dataVersion","_reconnectAttempts","_maxReconnectAttempts","_reconnectDelay","_reconnectTimeout","getConfigElement","document","createElement","getStubConfig","getCardSize","connectedCallback","init","initThreeJS","connectWebSocket","loadRobot","err","console","error","showError","message","container","querySelector","canvas","appendChild","THREE","import","OrbitControls","_THREE","default","_scene","Scene","background","Color","_camera","PerspectiveCamera","clientWidth","position","set","_renderer","WebGLRenderer","antialias","setSize","setPixelRatio","Math","min","devicePixelRatio","_controls","enableDamping","dampingFactor","minDistance","maxDistance","add","AmbientLight","directionalLight","DirectionalLight","backLight","GridHelper","_fpsCounter","frameCount","lastTime","performance","now","fps","animate","requestAnimationFrame","currentTime","fpsEl","textContent","update","basePath","getBasePath","URDFLoader","loader","workingPath","_robot","load","_initializeJoints","loading","style","display","joints","setJointValue","forEach","jointName","traverse","child","isObject3D","updateMatrix","updateMatrixWorld","scripts","getElementsByTagName","src","length","substring","lastIndexOf","wsUrl","log","_ws","WebSocket","onopen","updateStatus","onmessage","data","JSON","parse","_processRobotData","onerror","onclose","delay","pow","setTimeout","head_joints","Array","isArray","head_pose","headPoseArray","m","antennas_position","passive_joints","_updateRobot","j","index","passiveArray","i","state","msg","el","className","disconnectedCallback","close","clearTimeout","dispose","clear"],"mappings":"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"}