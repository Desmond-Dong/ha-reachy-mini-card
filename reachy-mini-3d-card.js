!function(){"use strict";window.customCards=window.customCards||[],window.customCards.push({type:"reachy-mini-3d-card",name:"Reachy Mini 3D Card",description:"Real-time 3D visualization of Reachy Mini robot",preview:!0,documentationURL:"https://github.com/Desmond-Dong/ha-reachy-mini-card"});class ReachyMini3DCard extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}setConfig(t){this._config={daemon_host:"localhost",daemon_port:3333,height:400,...t}}getCardSize(){return this._config.height?this._config.height/50:8}async connectedCallback(){this.render(),await this.init()}render(){this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n      </style>\n      <ha-card>\n        <div id="container">\n          <div id="status" class="connecting">Connecting...</div>\n          <div id="loading" class="loading">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `}async init(){try{await this.loadScripts(),this.initThreeJS(),this.connectWebSocket(),this.loadRobot()}catch(t){console.error("Init error:",t),this.showError(t.message)}}async loadScripts(){const t=t=>new Promise((e,n)=>{if(document.querySelector(`script[src="${t}"]`))return e();const s=document.createElement("script");s.src=t,s.onload=e,s.onerror=()=>n(new Error(`Failed to load ${t}`)),document.head.appendChild(s)});window.THREE||await t("https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"),await t("https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"),await t("https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js")}initThreeJS(){const t=this.shadowRoot.querySelector("#container"),e=document.createElement("canvas");t.appendChild(e),this._scene=new THREE.Scene,this._scene.background=new THREE.Color(16119285),this._camera=new THREE.PerspectiveCamera(50,t.clientWidth/this._config.height,.01,1e3),this._camera.position.set(.3,.3,.5),this._renderer=new THREE.WebGLRenderer({canvas:e,antialias:!0}),this._renderer.setSize(t.clientWidth,this._config.height),this._renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this._controls=new THREE.OrbitControls(this._camera,e),this._controls.enableDamping=!0,this._controls.minDistance=.2,this._controls.maxDistance=1,this._scene.add(new THREE.AmbientLight(16777215,.6));const n=new THREE.DirectionalLight(16777215,.8);n.position.set(1,1,1),this._scene.add(n),this._scene.add(new THREE.GridHelper(.4,20,8947848,13421772));const s=()=>{requestAnimationFrame(s),this._controls.update(),this._renderer.render(this._scene,this._camera)};s()}async loadRobot(){const t=this.getBasePath(),{default:e}=await import(`${t}lib/urdf-loader.js`),n=new e;n.workingPath=`${t}assets/`,this._robot=await n.load(`${t}assets/reachy-mini.urdf`),this._scene.add(this._robot);const s=this.shadowRoot.querySelector("#loading");s&&(s.style.display="none")}getBasePath(){const t=document.getElementsByTagName("script"),e=t[t.length-1]?.src||"";return e?e.substring(0,e.lastIndexOf("/")+1):"/hacsfiles/reachy-mini-3d-card/"}connectWebSocket(){const{daemon_host:t,daemon_port:e}=this._config,n=`ws://${t}:${e}/api/state/ws/full?frequency=20&with_head_joints=true&with_antenna_positions=true`;this._ws=new WebSocket(n),this._ws.onopen=()=>{this.updateStatus("connected","Connected")},this._ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.updateRobot(e)}catch(t){console.error("Parse error:",t)}},this._ws.onerror=()=>this.updateStatus("error","Error"),this._ws.onclose=()=>{this.updateStatus("error","Disconnected"),setTimeout(()=>this.connectWebSocket(),3e3)}}updateRobot(t){if(this._robot){if(7===t.head_joints?.length){const e=t.head_joints;this._robot.setJointValue("yaw_body",e[0]),this._robot.setJointValue("stewart_1",e[1]),this._robot.setJointValue("stewart_2",e[2]),this._robot.setJointValue("stewart_3",e[3]),this._robot.setJointValue("stewart_4",e[4]),this._robot.setJointValue("stewart_5",e[5]),this._robot.setJointValue("stewart_6",e[6])}2===t.antennas_position?.length&&(this._robot.setJointValue("left_antenna",-t.antennas_position[0]),this._robot.setJointValue("right_antenna",-t.antennas_position[1]))}}updateStatus(t,e){const n=this.shadowRoot.querySelector("#status");n&&(n.className=t,n.textContent=e)}showError(t){this.shadowRoot.querySelector("#container").innerHTML=`\n      <div style="padding: 20px; color: #f44336;">Error: ${t}</div>\n    `}disconnectedCallback(){this._ws&&this._ws.close(),this._renderer&&this._renderer.dispose()}}customElements.define("reachy-mini-3d-card",ReachyMini3DCard)}();
//# sourceMappingURL=reachy-mini-3d-card.js.map
