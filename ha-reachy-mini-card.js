!function(){"use strict";!function(){const t=["passive_1_x","passive_1_y","passive_1_z","passive_2_x","passive_2_y","passive_2_z","passive_3_x","passive_3_y","passive_3_z","passive_4_x","passive_4_y","passive_4_z","passive_5_x","passive_5_y","passive_5_z","passive_6_x","passive_6_y","passive_6_z","passive_7_x","passive_7_y","passive_7_z"];class e extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}setConfig(t){this._config=t,this.render()}render(){const t=this._config||{};this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        .form-row {\n          display: flex;\n          flex-direction: column;\n          margin-bottom: 12px;\n        }\n        label {\n          font-size: 14px;\n          font-weight: 500;\n          margin-bottom: 4px;\n          color: var(--primary-text-color);\n        }\n        input[type="text"],\n        input[type="number"] {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid var(--primary-color);\n          border-radius: 4px;\n          background: var(--card-background-color);\n          color: var(--primary-text-color);\n          box-sizing: border-box;\n        }\n        input[type="text"]:focus,\n        input[type="number"]:focus {\n          outline: none;\n          border-color: var(--accent-color);\n        }\n        .checkbox-row {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          margin-bottom: 8px;\n        }\n        .checkbox-row input[type="checkbox"] {\n          width: auto;\n          margin: 0;\n        }\n        .checkbox-row label {\n          margin-bottom: 0;\n          flex: 1;\n        }\n        .hint {\n          font-size: 12px;\n          color: var(--secondary-text-color);\n          margin-top: 4px;\n        }\n        .section-title {\n          font-size: 13px;\n          font-weight: 600;\n          color: var(--primary-text-color);\n          margin-top: 16px;\n          margin-bottom: 8px;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n        }\n      </style>\n\n      <div class="section-title">Connection</div>\n\n      <div class="form-row">\n        <label for="host">Daemon Host</label>\n        <input\n          id="host"\n          type="text"\n          value="${t.daemon_host||"localhost"}"\n          placeholder="localhost or IP address"\n        />\n        <div class="hint">Reachy Mini daemon hostname or IP address</div>\n      </div>\n\n      <div class="form-row">\n        <label for="port">Daemon Port</label>\n        <input\n          id="port"\n          type="number"\n          value="${t.daemon_port||8e3}"\n          placeholder="8000"\n        />\n        <div class="hint">WebSocket port (default: 8000)</div>\n      </div>\n\n      <div class="section-title">Display</div>\n\n      <div class="form-row">\n        <label for="height">Card Height (px)</label>\n        <input\n          id="height"\n          type="number"\n          value="${t.height||400}"\n          placeholder="400"\n        />\n        <div class="hint">Height of the card in pixels</div>\n      </div>\n\n      <div class="form-row">\n        <label for="background">Background Color</label>\n        <input\n          id="background"\n          type="text"\n          value="${t.background_color||"#f5f5f5"}"\n          placeholder="#f5f5f5"\n        />\n        <div class="hint">Background color (hex code)</div>\n      </div>\n\n      <div class="form-row">\n        <label for="camera_distance">Camera Distance</label>\n        <input\n          id="camera_distance"\n          type="number"\n          step="0.1"\n          value="${t.camera_distance||.5}"\n          placeholder="0.5"\n        />\n        <div class="hint">Initial camera distance (0.2 - 1.5)</div>\n      </div>\n\n      <div class="section-title">Features</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_passive" ${!1!==t.enable_passive_joints?"checked":""}>\n        <label for="enable_passive">Enable Passive Joints</label>\n      </div>\n      <div class="hint">Show Stewart platform passive joints (requires daemon support)</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_pose" ${!1!==t.enable_head_pose?"checked":""}>\n        <label for="enable_pose">Enable Head Pose</label>\n      </div>\n      <div class="hint">Use 4x4 pose matrix for head positioning</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_grid" ${!1!==t.enable_grid?"checked":""}>\n        <label for="enable_grid">Show Grid</label>\n      </div>\n      <div class="hint">Display ground grid helper</div>\n    `,this.shadowRoot.getElementById("host").addEventListener("change",t=>{this._config={...this._config,daemon_host:t.target.value},this.dispatchConfig()}),this.shadowRoot.getElementById("port").addEventListener("change",t=>{this._config={...this._config,daemon_port:parseInt(t.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("height").addEventListener("change",t=>{this._config={...this._config,height:parseInt(t.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("background").addEventListener("change",t=>{this._config={...this._config,background_color:t.target.value},this.dispatchConfig()}),this.shadowRoot.getElementById("camera_distance").addEventListener("change",t=>{this._config={...this._config,camera_distance:parseFloat(t.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_passive").addEventListener("change",t=>{this._config={...this._config,enable_passive_joints:t.target.checked},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_pose").addEventListener("change",t=>{this._config={...this._config,enable_head_pose:t.target.checked},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_grid").addEventListener("change",t=>{this._config={...this._config,enable_grid:t.target.checked},this.dispatchConfig()})}dispatchConfig(){const t=new CustomEvent("config-changed",{detail:{config:this._config},bubbles:!0,composed:!0});this.dispatchEvent(t)}}customElements.define("ha-reachy-mini-card-editor",e);class n extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._frameCount=0,this._lastDataVersion=-1,this._robotState={headJoints:null,headPose:null,passiveJoints:null,antennas:[0,0],dataVersion:0},this._reconnectAttempts=0,this._maxReconnectAttempts=10,this._reconnectDelay=3e3,this._reconnectTimeout=null}static get getConfigElement(){return document.createElement("ha-reachy-mini-card-editor")}static getStubConfig(){return{daemon_host:"localhost",daemon_port:8e3,height:400,enable_passive_joints:!0,enable_head_pose:!0,background_color:"#f5f5f5",enable_grid:!0,camera_distance:.5}}setConfig(t){this._config={daemon_host:"localhost",daemon_port:8e3,height:400,enable_passive_joints:!0,enable_head_pose:!0,background_color:"#f5f5f5",enable_grid:!0,camera_distance:.5,...t}}getCardSize(){return this._config.height?this._config.height/50:8}async connectedCallback(){this.render(),await this.init()}render(){this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n          transition: all 0.3s ease;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n        #fps-counter {\n          position: absolute;\n          top: 10px;\n          right: 10px;\n          padding: 4px 8px;\n          border-radius: 12px;\n          font-size: 11px;\n          font-weight: 500;\n          color: white;\n          background: rgba(0, 0, 0, 0.6);\n          z-index: 10;\n        }\n      </style>\n      <ha-card>\n        <div id="container">\n          <div id="status" class="connecting">Connecting...</div>\n          <div id="fps-counter">0 FPS</div>\n          <div id="loading" class="loading">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `}async init(){try{await this.loadThreeJS(),await this.connectWebSocket(),await this.loadRobot()}catch(t){console.error("Init error:",t),this.showError(t.message)}}async loadThreeJS(){return new Promise((t,e)=>{if(window.THREE&&window.OrbitControls)return console.log("âœ… Three.js already loaded"),void t();console.log("ðŸ“¦ Loading Three.js...");const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/three@0.181.0/build/three.min.js",n.crossOrigin="anonymous",n.onload=()=>{console.log("âœ… Three.js loaded");const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/three@0.181.0/examples/js/controls/OrbitControls.js",n.crossOrigin="anonymous",n.onload=()=>{console.log("âœ… OrbitControls loaded"),t()},n.onerror=()=>{console.error("âŒ Failed to load OrbitControls"),e(new Error("Failed to load OrbitControls"))},document.head.appendChild(n)},n.onerror=()=>{console.error("âŒ Failed to load Three.js"),e(new Error("Failed to load Three.js"))},document.head.appendChild(n)})}async connectWebSocket(){const{daemon_host:t,daemon_port:e}=this._config;let n=`ws://${t}:${e}/api/state/ws/full?frequency=20`;n+="&with_head_joints=true",n+="&with_antenna_positions=true",!1!==this._config.enable_passive_joints&&(n+="&with_passive_joints=true"),!1!==this._config.enable_head_pose&&(n+="&with_head_pose=true",n+="&use_pose_matrix=true"),console.log("ðŸ”Œ Connecting to WebSocket:",n),this._ws=new WebSocket(n),this._ws.onopen=()=>{console.log("âœ… WebSocket connected"),this._reconnectAttempts=0,this.updateStatus("connected","Connected")},this._ws.onmessage=t=>{try{const e=JSON.parse(t.data);this._processRobotData(e)}catch(t){console.error("âŒ Parse error:",t)}},this._ws.onerror=t=>{console.error("âŒ WebSocket error:",t),this.updateStatus("error","Error")},this._ws.onclose=()=>{if(console.log("ðŸ”Œ WebSocket closed"),this.updateStatus("error","Disconnected"),this._reconnectAttempts<this._maxReconnectAttempts){this._reconnectAttempts++;const t=Math.min(this._reconnectDelay*Math.pow(1.5,this._reconnectAttempts-1),3e4);console.log(`ðŸ”„ Reconnecting in ${t}ms (attempt ${this._reconnectAttempts}/${this._maxReconnectAttempts})`),this._reconnectTimeout=setTimeout(()=>{this.connectWebSocket()},t)}else console.error("âŒ Max reconnection attempts reached"),this.updateStatus("error","Connection Failed")}}_processRobotData(t){if(t.head_joints&&Array.isArray(t.head_joints)&&7===t.head_joints.length&&(this._robotState.headJoints=t.head_joints),t.head_pose){const e=Array.isArray(t.head_pose)?t.head_pose:t.head_pose.m;e&&16===e.length&&(this._robotState.headPose=e)}t.antennas_position&&Array.isArray(t.antennas_position)&&t.antennas_position.length>=2&&(this._robotState.antennas=t.antennas_position),t.passive_joints&&Array.isArray(t.passive_joints)&&t.passive_joints.length>=21&&(this._robotState.passiveJoints=t.passive_joints),this._robotState.dataVersion++,this._updateRobot()}_updateRobot(){if(this._robot&&(this._frameCount++,this._frameCount%3==0&&this._robotState.dataVersion!==this._lastDataVersion)){if(this._lastDataVersion=this._robotState.dataVersion,this._robotState.headJoints){const t=this._robotState.headJoints;this._robot.joints.yaw_body&&this._robot.setJointValue("yaw_body",t[0]),["stewart_1","stewart_2","stewart_3","stewart_4","stewart_5","stewart_6"].forEach((e,n)=>{this._robot.joints[e]&&this._robot.setJointValue(e,t[n+1])})}if(!1!==this._config.enable_passive_joints&&this._robotState.passiveJoints){const e=this._robotState.passiveJoints;for(let n=0;n<21;n++){const o=t[n];this._robot.joints[o]&&this._robot.setJointValue(o,e[n])}}if(this._robotState.antennas){const t=this._robotState.antennas;this._robot.joints.left_antenna&&this._robot.setJointValue("left_antenna",-t[1]),this._robot.joints.right_antenna&&this._robot.setJointValue("right_antenna",-t[0])}}}async loadRobot(){const t=this.getBasePath(),e=document.createElement("script");e.src=`${t}lib/URDFClasses.js`,document.head.appendChild(e),await new Promise(t=>e.onload=t);const n=document.createElement("script");n.src=`${t}lib/URDFDragControls.js`,document.head.appendChild(n),await new Promise(t=>n.onload=t);const o=document.createElement("script");o.src=`${t}lib/urdf-loader.js`,document.head.appendChild(o),await new Promise(t=>o.onload=t);const s=new window.URDFLoader;s.workingPath=`${t}assets/`,this._robot=await s.load(`${t}assets/reachy-mini.urdf`),this._scene.add(this._robot),this._initializeJoints();const i=this.shadowRoot.querySelector("#loading");i&&(i.style.display="none"),this._startAnimation()}_initializeJoints(){this._robot&&this._robot.joints&&(this._robot.joints.yaw_body&&this._robot.setJointValue("yaw_body",0),["stewart_1","stewart_2","stewart_3","stewart_4","stewart_5","stewart_6"].forEach(t=>{this._robot.joints[t]&&this._robot.setJointValue(t,0)}),t.forEach(t=>{this._robot.joints[t]&&this._robot.setJointValue(t,0)}),["left_antenna","right_antenna"].forEach(t=>{this._robot.joints[t]&&this._robot.setJointValue(t,0)}))}_startAnimation(){const t=this.shadowRoot.querySelector("#container"),e=document.createElement("canvas");t.appendChild(e);const n=window.THREE;this._scene=new n.Scene,this._scene.background=new n.Color(this._config.background_color||"#f5f5f5"),this._camera=new n.PerspectiveCamera(50,t.clientWidth/this._config.height,.01,1e3),this._camera.position.set(.3,.3,this._config.camera_distance||.5),this._renderer=new n.WebGLRenderer({canvas:e,antialias:!0}),this._renderer.setSize(t.clientWidth,this._config.height),this._renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this._controls=new window.OrbitControls(this._camera,e),this._controls.enableDamping=!0,this._controls.dampingFactor=.05,this._controls.minDistance=.2,this._controls.maxDistance=1.5,this._scene.add(new n.AmbientLight(16777215,.6));const o=new n.DirectionalLight(16777215,.8);o.position.set(1,1,1),this._scene.add(o);const s=new n.DirectionalLight(16777215,.3);s.position.set(-1,-1,-1),this._scene.add(s),!1!==this._config.enable_grid&&this._scene.add(new n.GridHelper(.4,20,8947848,13421772)),this._fpsCounter={frameCount:0,lastTime:performance.now(),fps:0};const i=()=>{requestAnimationFrame(i),this._fpsCounter.frameCount++;const t=performance.now();if(t-this._fpsCounter.lastTime>=1e3){this._fpsCounter.fps=this._fpsCounter.frameCount,this._fpsCounter.frameCount=0,this._fpsCounter.lastTime=t;const e=this.shadowRoot.querySelector("#fps-counter");e&&(e.textContent=`${this._fpsCounter.fps} FPS`)}this._controls.update(),this._renderer.render(this._scene,this._camera)};i()}updateStatus(t,e){const n=this.shadowRoot.querySelector("#status");n&&(n.className=t,n.textContent=e)}showError(t){const e=this.shadowRoot.querySelector("#container");e&&(e.innerHTML=`\n          <div style="padding: 20px; color: #f44336;">Error: ${t}</div>\n        `)}getBasePath(){const t=document.getElementsByTagName("script"),e=t[t.length-1],n=e?.src||"";return n?n.substring(0,n.lastIndexOf("/")+1):"/hacsfiles/ha-reachy-mini-card/"}disconnectedCallback(){this._ws&&(this._ws.close(),this._ws=null),this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null),this._renderer&&(this._renderer.dispose(),this._renderer=null),this._scene&&(this._scene.clear(),this._scene=null)}}customElements.define("ha-reachy-mini-card",n)}()}();
//# sourceMappingURL=ha-reachy-mini-card.js.map
