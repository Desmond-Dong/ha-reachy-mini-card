{"version":3,"file":"ha-reachy-mini-card.js","sources":["../../../src/ha-reachy-mini-card.js"],"sourcesContent":["// Reachy Mini 3D Card - Direct Daemon Connection\r\n// Version: 3.1.0\r\n// https://github.com/Desmond-Dong/ha-reachy-mini-card\r\n\r\n/* global OrbitControls */\r\n\r\n(function () {\r\n  'use strict';\r\n\r\n  // Ë¢´Âä®ÂÖ≥ËäÇÂêçÁß∞Â∏∏Èáè\r\n  const PASSIVE_JOINT_NAMES = [\r\n    'passive_1_x', 'passive_1_y', 'passive_1_z',\r\n    'passive_2_x', 'passive_2_y', 'passive_2_z',\r\n    'passive_3_x', 'passive_3_y', 'passive_3_z',\r\n    'passive_4_x', 'passive_4_y', 'passive_4_z',\r\n    'passive_5_x', 'passive_5_y', 'passive_5_z',\r\n    'passive_6_x', 'passive_6_y', 'passive_6_z',\r\n    'passive_7_x', 'passive_7_y', 'passive_7_z',\r\n  ];\r\n\r\n  // ÈÖçÁΩÆÁºñËæëÂô® - ÂøÖÈ°ªÂú®‰∏ªÂç°‰πãÂâçÂÆö‰πâÂíåÊ≥®ÂÜå\r\n  class ReachyMini3DCardEditor extends HTMLElement {\r\n    constructor() {\r\n      super();\r\n      this.attachShadow({ mode: 'open' });\r\n    }\r\n\r\n    setConfig(config) {\r\n      this._config = config;\r\n      this.render();\r\n    }\r\n\r\n    render() {\r\n      const config = this._config || {};\r\n\r\n      this.shadowRoot.innerHTML = `\r\n      <style>\r\n        :host { display: block; }\r\n        .form-row {\r\n          display: flex;\r\n          flex-direction: column;\r\n          margin-bottom: 12px;\r\n        }\r\n        label {\r\n          font-size: 14px;\r\n          font-weight: 500;\r\n          margin-bottom: 4px;\r\n          color: var(--primary-text-color);\r\n        }\r\n        input[type=\"text\"],\r\n        input[type=\"number\"] {\r\n          width: 100%;\r\n          padding: 8px;\r\n          border: 1px solid var(--primary-color);\r\n          border-radius: 4px;\r\n          background: var(--card-background-color);\r\n          color: var(--primary-text-color);\r\n          box-sizing: border-box;\r\n        }\r\n        input[type=\"text\"]:focus,\r\n        input[type=\"number\"]:focus {\r\n          outline: none;\r\n          border-color: var(--accent-color);\r\n        }\r\n        .checkbox-row {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 8px;\r\n          margin-bottom: 8px;\r\n        }\r\n        .checkbox-row input[type=\"checkbox\"] {\r\n          width: auto;\r\n          margin: 0;\r\n        }\r\n        .checkbox-row label {\r\n          margin-bottom: 0;\r\n          flex: 1;\r\n        }\r\n        .hint {\r\n          font-size: 12px;\r\n          color: var(--secondary-text-color);\r\n          margin-top: 4px;\r\n        }\r\n        .section-title {\r\n          font-size: 13px;\r\n          font-weight: 600;\r\n          color: var(--primary-text-color);\r\n          margin-top: 16px;\r\n          margin-bottom: 8px;\r\n          text-transform: uppercase;\r\n          letter-spacing: 0.5px;\r\n        }\r\n      </style>\r\n\r\n      <div class=\"section-title\">Connection</div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"host\">Daemon Host</label>\r\n        <input\r\n          id=\"host\"\r\n          type=\"text\"\r\n          value=\"${config.daemon_host || 'localhost'}\"\r\n          placeholder=\"localhost or IP address\"\r\n        />\r\n        <div class=\"hint\">Reachy Mini daemon hostname or IP address</div>\r\n      </div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"port\">Daemon Port</label>\r\n        <input\r\n          id=\"port\"\r\n          type=\"number\"\r\n          value=\"${config.daemon_port || 8000}\"\r\n          placeholder=\"8000\"\r\n        />\r\n        <div class=\"hint\">WebSocket port (default: 8000)</div>\r\n      </div>\r\n\r\n      <div class=\"section-title\">Display</div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"height\">Card Height (px)</label>\r\n        <input\r\n          id=\"height\"\r\n          type=\"number\"\r\n          value=\"${config.height || 400}\"\r\n          placeholder=\"400\"\r\n        />\r\n        <div class=\"hint\">Height of the card in pixels</div>\r\n      </div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"background\">Background Color</label>\r\n        <input\r\n          id=\"background\"\r\n          type=\"text\"\r\n          value=\"${config.background_color || '#f5f5f5'}\"\r\n          placeholder=\"#f5f5f5\"\r\n        />\r\n        <div class=\"hint\">Background color (hex code)</div>\r\n      </div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"camera_distance\">Camera Distance</label>\r\n        <input\r\n          id=\"camera_distance\"\r\n          type=\"number\"\r\n          step=\"0.1\"\r\n          value=\"${config.camera_distance || 0.5}\"\r\n          placeholder=\"0.5\"\r\n        />\r\n        <div class=\"hint\">Initial camera distance (0.2 - 1.5)</div>\r\n      </div>\r\n\r\n      <div class=\"section-title\">Features</div>\r\n\r\n      <div class=\"checkbox-row\">\r\n        <input type=\"checkbox\" id=\"enable_passive\" ${config.enable_passive_joints !== false ? 'checked' : ''}>\r\n        <label for=\"enable_passive\">Enable Passive Joints</label>\r\n      </div>\r\n      <div class=\"hint\">Show Stewart platform passive joints (requires daemon support)</div>\r\n\r\n      <div class=\"checkbox-row\">\r\n        <input type=\"checkbox\" id=\"enable_pose\" ${config.enable_head_pose !== false ? 'checked' : ''}>\r\n        <label for=\"enable_pose\">Enable Head Pose</label>\r\n      </div>\r\n      <div class=\"hint\">Use 4x4 pose matrix for head positioning</div>\r\n\r\n      <div class=\"checkbox-row\">\r\n        <input type=\"checkbox\" id=\"enable_grid\" ${config.enable_grid !== false ? 'checked' : ''}>\r\n        <label for=\"enable_grid\">Show Grid</label>\r\n      </div>\r\n      <div class=\"hint\">Display ground grid helper</div>\r\n    `;\r\n\r\n      // ÁõëÂê¨ËæìÂÖ•ÂèòÂåñ\r\n      this.shadowRoot.getElementById('host').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, daemon_host: e.target.value };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('port').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, daemon_port: parseInt(e.target.value) };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('height').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, height: parseInt(e.target.value) };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('background').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, background_color: e.target.value };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('camera_distance').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, camera_distance: parseFloat(e.target.value) };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('enable_passive').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, enable_passive_joints: e.target.checked };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('enable_pose').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, enable_head_pose: e.target.checked };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('enable_grid').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, enable_grid: e.target.checked };\r\n        this.dispatchConfig();\r\n      });\r\n    }\r\n\r\n    dispatchConfig() {\r\n      const event = new CustomEvent('config-changed', {\r\n        detail: { config: this._config },\r\n        bubbles: true,\r\n        composed: true\r\n      });\r\n      this.dispatchEvent(event);\r\n    }\r\n  }\r\n\r\n  // Ê≥®ÂÜåÁºñËæëÂô®ÔºàÈò≤Ê≠¢ÈáçÂ§çÊ≥®ÂÜåÔºâ\r\n  if (!customElements.get('ha-reachy-mini-card-editor')) {\r\n    customElements.define('ha-reachy-mini-card-editor', ReachyMini3DCardEditor);\r\n  }\r\n\r\n  // ‰∏ªÂç°ÁâáÁªÑ‰ª∂\r\n  class ReachyMini3DCard extends HTMLElement {\r\n    constructor() {\r\n      super();\r\n      this.attachShadow({ mode: 'open' });\r\n      this._frameCount = 0;\r\n      this._lastDataVersion = -1;\r\n      this._robotState = {\r\n        headJoints: null,\r\n        headPose: null,\r\n        passiveJoints: null,\r\n        antennas: [0, 0],\r\n        dataVersion: 0\r\n      };\r\n      this._reconnectAttempts = 0;\r\n      this._maxReconnectAttempts = 10;\r\n      this._reconnectDelay = 3000;\r\n      this._reconnectTimeout = null;\r\n    }\r\n\r\n    static getConfigElement() {\r\n      return document.createElement('ha-reachy-mini-card-editor');\r\n    }\r\n\r\n    static getStubConfig() {\r\n      return {\r\n        daemon_host: 'localhost',\r\n        daemon_port: 8000,\r\n        height: 400,\r\n        enable_passive_joints: true,\r\n        enable_head_pose: true,\r\n        background_color: '#f5f5f5',\r\n        enable_grid: true,\r\n        camera_distance: 0.5\r\n      };\r\n    }\r\n\r\n    setConfig(config) {\r\n      this._config = {\r\n        daemon_host: 'localhost',\r\n        daemon_port: 8000,\r\n        height: 400,\r\n        enable_passive_joints: true,\r\n        enable_head_pose: true,\r\n        background_color: '#f5f5f5',\r\n        enable_grid: true,\r\n        camera_distance: 0.5,\r\n        ...config\r\n      };\r\n    }\r\n\r\n    getCardSize() {\r\n      return this._config.height ? this._config.height / 50 : 8;\r\n    }\r\n\r\n    getGridOptions() {\r\n      // Grid options for sections view (12 columns grid)\r\n      const height = this._config.height || 400;\r\n      const rows = Math.ceil(height / 50);\r\n      return {\r\n        rows: rows,\r\n        columns: 6,\r\n        min_rows: 4,\r\n        max_rows: 20,\r\n      };\r\n    }\r\n\r\n    set hass(hass) {\r\n      // Store Home Assistant instance (required by custom card API)\r\n      this._hass = hass;\r\n      // This card doesn't use HA entities directly, but set hass is required\r\n    }\r\n\r\n    async connectedCallback() {\r\n      this.render();\r\n      await this.init();\r\n    }\r\n\r\n    render() {\r\n      this.shadowRoot.innerHTML = `\r\n      <style>\r\n        :host { display: block; }\r\n        ha-card {\r\n          overflow: hidden;\r\n          border-radius: var(--ha-card-border-radius, 12px);\r\n          box-shadow: var(--ha-card-box-shadow, none);\r\n        }\r\n        #container {\r\n          position: relative;\r\n          width: 100%;\r\n          height: ${this._config.height}px;\r\n        }\r\n        #status {\r\n          position: absolute;\r\n          top: 10px;\r\n          left: 10px;\r\n          padding: 6px 12px;\r\n          border-radius: 20px;\r\n          font-size: 12px;\r\n          font-weight: 500;\r\n          color: white;\r\n          z-index: 10;\r\n          transition: all 0.3s ease;\r\n        }\r\n        .connected { background: #4caf50; }\r\n        .connecting { background: #ff9800; }\r\n        .error { background: #f44336; }\r\n        .loading {\r\n          position: absolute;\r\n          top: 50%;\r\n          left: 50%;\r\n          transform: translate(-50%, -50%);\r\n        }\r\n        #fps-counter {\r\n          position: absolute;\r\n          top: 10px;\r\n          right: 10px;\r\n          padding: 4px 8px;\r\n          border-radius: 12px;\r\n          font-size: 11px;\r\n          font-weight: 500;\r\n          color: white;\r\n          background: rgba(0, 0, 0, 0.6);\r\n          z-index: 10;\r\n        }\r\n      </style>\r\n      <ha-card>\r\n        <div id=\"container\">\r\n          <div id=\"status\" class=\"connecting\">Connecting...</div>\r\n          <div id=\"fps-counter\">0 FPS</div>\r\n          <div id=\"loading\" class=\"loading\">\r\n            <ha-circular-progress indeterminate></ha-circular-progress>\r\n          </div>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n    }\r\n\r\n    async init() {\r\n      try {\r\n        await this.loadThreeJS();\r\n        this._setupScene();\r\n        await this.loadRobot();\r\n        this.startPolling();\r\n      } catch (err) {\r\n        console.error('Init error:', err);\r\n        this.showError(err.message);\r\n      }\r\n    }\r\n\r\n    async loadThreeJS() {\r\n      const basePath = this.getBasePath();\r\n      \r\n      // Check if already loaded\r\n      if (typeof THREE !== 'undefined' && THREE && THREE.WebGLRenderer) {\r\n        console.log('‚úÖ Three.js already loaded');\r\n        return;\r\n      }\r\n\r\n      console.log('üì¶ Loading Three.js...');\r\n      \r\n      try {\r\n        // Load Three.js from local file (flat structure in dist/)\r\n        const threeModule = await import(`${basePath}three.module.js`);\r\n        window.THREE = threeModule;\r\n        console.log('‚úÖ Three.js loaded');\r\n        \r\n        // Load OrbitControls\r\n        const orbitControlsModule = await import(`${basePath}OrbitControls.js`);\r\n        window.OrbitControls = orbitControlsModule.OrbitControls || orbitControlsModule.default;\r\n        console.log('‚úÖ OrbitControls loaded');\r\n      } catch (error) {\r\n        console.error('‚ùå Failed to load Three.js:', error);\r\n        throw new Error('Failed to load Three.js: ' + error.message);\r\n      }\r\n    }\r\n\r\n    startPolling() {\r\n      const { daemon_host, daemon_port } = this._config;\r\n      const apiUrl = `http://${daemon_host}:${daemon_port}/api/state/full?with_control_mode=true&with_head_joints=true&with_body_yaw=true&with_antenna_positions=true&with_passive_joints=true`;\r\n      \r\n      console.log('üîÑ Starting polling:', apiUrl);\r\n      \r\n      this._pollingInterval = setInterval(async () => {\r\n        try {\r\n          const response = await fetch(apiUrl);\r\n          if (response.ok) {\r\n            const data = await response.json();\r\n            this._processRobotData(data);\r\n            this.updateStatus('connected', 'Connected');\r\n          } else {\r\n            console.error('‚ùå API error:', response.status);\r\n            this.updateStatus('error', `Error: ${response.status}`);\r\n          }\r\n        } catch (err) {\r\n          console.error('‚ùå Polling error:', err);\r\n          this.updateStatus('error', 'Connection Failed');\r\n        }\r\n      }, 50); // Poll every 50ms (20Hz) like reference project\r\n    }\r\n\r\n    _processRobotData(data) {\r\n      // head_joints: Array of 7 values [yaw_body, stewart_1, ..., stewart_6]\r\n      if (data.head_joints && Array.isArray(data.head_joints) && data.head_joints.length >= 7) {\r\n        this._robotState.headJoints = data.head_joints;\r\n      }\r\n      \r\n      // body_yaw: Single value (same as head_joints[0])\r\n      if (data.body_yaw !== undefined) {\r\n        if (!this._robotState.headJoints) {\r\n          this._robotState.headJoints = [];\r\n        }\r\n        this._robotState.headJoints[0] = data.body_yaw;\r\n      }\r\n      \r\n      // head_pose: Object with x, y, z, roll, pitch, yaw\r\n      if (data.head_pose) {\r\n        this._robotState.headPose = data.head_pose;\r\n      }\r\n      \r\n      // antennas_position: Array of 2 values [left, right]\r\n      if (data.antennas_position && Array.isArray(data.antennas_position) && data.antennas_position.length >= 2) {\r\n        this._robotState.antennas = data.antennas_position;\r\n      }\r\n      \r\n      // passive_joints: Array of 21 values or null\r\n      if (data.passive_joints && Array.isArray(data.passive_joints) && data.passive_joints.length >= 21) {\r\n        this._robotState.passiveJoints = data.passive_joints;\r\n      }\r\n      \r\n      this._robotState.dataVersion++;\r\n      this._updateRobot();\r\n    }\r\n\r\n    _updateRobot() {\r\n      if (!this._robot) return;\r\n\r\n      // Apply head joints\r\n      if (this._robotState.headJoints) {\r\n        const joints = this._robotState.headJoints;\r\n        if (this._robot.joints['yaw_body']) {\r\n          this._robot.setJointValue('yaw_body', joints[0]);\r\n        }\r\n        ['stewart_1', 'stewart_2', 'stewart_3', 'stewart_4', 'stewart_5', 'stewart_6'].forEach((name, i) => {\r\n          if (this._robot.joints[name]) {\r\n            this._robot.setJointValue(name, joints[i + 1]);\r\n          }\r\n        });\r\n      }\r\n\r\n      // Apply passive joints\r\n      if (this._config.enable_passive_joints !== false && this._robotState.passiveJoints) {\r\n        const passiveJoints = this._robotState.passiveJoints;\r\n        for (let i = 0; i < 21; i++) {\r\n          const jointName = PASSIVE_JOINT_NAMES[i];\r\n          if (this._robot.joints[jointName]) {\r\n            this._robot.setJointValue(jointName, passiveJoints[i]);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Apply antennas\r\n      if (this._robotState.antennas) {\r\n        const antennas = this._robotState.antennas;\r\n        if (this._robot.joints['left_antenna']) {\r\n          this._robot.setJointValue('left_antenna', -antennas[1]);\r\n        }\r\n        if (this._robot.joints['right_antenna']) {\r\n          this._robot.setJointValue('right_antenna', -antennas[0]);\r\n        }\r\n      }\r\n    }\r\n\r\n    async loadRobot() {\r\n      const basePath = this.getBasePath();\r\n      \r\n      // Âä®ÊÄÅÂä†ËΩΩ URDFLoader Áõ∏ÂÖ≥Ê®°Âùó (flat structure)\r\n      await import(`${basePath}URDFClasses.js`);\r\n      await import(`${basePath}URDFDragControls.js`);\r\n      \r\n      const URDFLoaderModule = await import(`${basePath}urdf-loader.js`);\r\n      const URDFLoader = URDFLoaderModule.default;\r\n      \r\n      const loader = new URDFLoader();\r\n      loader.workingPath = basePath;  // STL files are in meshes/ subdirectory (URDF references meshes/xxx.stl)\r\n      \r\n      this._robot = await loader.load(`${basePath}reachy-mini.urdf`);\r\n      this._scene.add(this._robot);\r\n\r\n      // Initialize all joints to zero\r\n      this._initializeJoints();\r\n\r\n      // Hide loading\r\n      const loading = this.shadowRoot.querySelector('#loading');\r\n      if (loading) loading.style.display = 'none';\r\n\r\n      // Start animation loop\r\n      this._startAnimationLoop();\r\n    }\r\n\r\n    _initializeJoints() {\r\n      if (!this._robot || !this._robot.joints) return;\r\n\r\n      // Initialize yaw_body\r\n      if (this._robot.joints['yaw_body']) {\r\n        this._robot.setJointValue('yaw_body', 0);\r\n      }\r\n\r\n      // Initialize stewart joints\r\n      ['stewart_1', 'stewart_2', 'stewart_3', 'stewart_4', 'stewart_5', 'stewart_6'].forEach(jointName => {\r\n        if (this._robot.joints[jointName]) {\r\n          this._robot.setJointValue(jointName, 0);\r\n        }\r\n      });\r\n\r\n      // Initialize passive joints\r\n      PASSIVE_JOINT_NAMES.forEach(jointName => {\r\n        if (this._robot.joints[jointName]) {\r\n          this._robot.setJointValue(jointName, 0);\r\n        }\r\n      });\r\n\r\n      // Initialize antennas\r\n      ['left_antenna', 'right_antenna'].forEach(jointName => {\r\n        if (this._robot.joints[jointName]) {\r\n          this._robot.setJointValue(jointName, 0);\r\n        }\r\n      });\r\n    }\r\n\r\n    _setupScene() {\r\n      const container = this.shadowRoot.querySelector('#container');\r\n      const canvas = document.createElement('canvas');\r\n      canvas.style.width = '100%';\r\n      canvas.style.height = '100%';\r\n      container.appendChild(canvas);\r\n      \r\n      // Scene\r\n      this._scene = new THREE.Scene();\r\n      this._scene.background = new THREE.Color(this._config.background_color || '#f5f5f5');\r\n\r\n      // Camera\r\n      this._camera = new THREE.PerspectiveCamera(\r\n        50,\r\n        container.clientWidth / this._config.height,\r\n        0.01,\r\n        1000\r\n      );\r\n      this._camera.position.set(0.3, 0.3, this._config.camera_distance || 0.5);\r\n\r\n      // Renderer\r\n      this._renderer = new THREE.WebGLRenderer({ canvas, antialias: true });\r\n      this._renderer.setSize(container.clientWidth, this._config.height);\r\n      this._renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\r\n\r\n      // Controls\r\n      this._controls = new OrbitControls(this._camera, canvas);\r\n      this._controls.enableDamping = true;\r\n      this._controls.dampingFactor = 0.05;\r\n      this._controls.minDistance = 0.2;\r\n      this._controls.maxDistance = 1.5;\r\n      this._controls.target.set(0, 0.15, 0);\r\n\r\n      // Lights\r\n      this._scene.add(new THREE.AmbientLight(0xffffff, 0.6));\r\n      \r\n      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);\r\n      directionalLight.position.set(1, 1, 1);\r\n      this._scene.add(directionalLight);\r\n      \r\n      const backLight = new THREE.DirectionalLight(0xffffff, 0.3);\r\n      backLight.position.set(-1, -1, -1);\r\n      this._scene.add(backLight);\r\n\r\n      // Grid\r\n      if (this._config.enable_grid !== false) {\r\n        this._scene.add(new THREE.GridHelper(0.4, 20, 0x888888, 0xcccccc));\r\n      }\r\n\r\n      // FPS counter\r\n      this._fpsCounter = {\r\n        frameCount: 0,\r\n        lastTime: performance.now(),\r\n        fps: 0\r\n      };\r\n    }\r\n\r\n    _startAnimationLoop() {\r\n      // Animation loop\r\n      const animate = () => {\r\n        this._animationId = requestAnimationFrame(animate);\r\n        \r\n        // Update robot state\r\n        this._updateRobot();\r\n        \r\n        // FPS calculation\r\n        this._fpsCounter.frameCount++;\r\n        const currentTime = performance.now();\r\n        if (currentTime - this._fpsCounter.lastTime >= 1000) {\r\n          this._fpsCounter.fps = this._fpsCounter.frameCount;\r\n          this._fpsCounter.frameCount = 0;\r\n          this._fpsCounter.lastTime = currentTime;\r\n          \r\n          const fpsEl = this.shadowRoot.querySelector('#fps-counter');\r\n          if (fpsEl) {\r\n            fpsEl.textContent = `${this._fpsCounter.fps} FPS`;\r\n          }\r\n        }\r\n        \r\n        this._controls.update();\r\n        this._renderer.render(this._scene, this._camera);\r\n      };\r\n      animate();\r\n    }\r\n\r\n    updateStatus(status, message) {\r\n      const statusEl = this.shadowRoot.querySelector('#status');\r\n      if (statusEl) {\r\n        statusEl.className = status;\r\n        statusEl.textContent = message;\r\n      }\r\n    }\r\n\r\n    showError(message) {\r\n      const container = this.shadowRoot.querySelector('#container');\r\n      if (container) {\r\n        container.innerHTML = `\r\n          <div style=\"padding: 20px; color: #f44336;\">Error: ${message}</div>\r\n        `;\r\n      }\r\n    }\r\n\r\n    getBasePath() {\r\n      // Integration static path (registered by __init__.py)\r\n      return '/reachy_mini_3d_static/';\r\n    }\r\n\r\ndisconnectedCallback() {\r\n      if (this._animationId) {\r\n        cancelAnimationFrame(this._animationId);\r\n        this._animationId = null;\r\n      }\r\n      if (this._pollingInterval) {\r\n        clearInterval(this._pollingInterval);\r\n        this._pollingInterval = null;\r\n      }\r\n      if (this._renderer) {\r\n        this._renderer.dispose();\r\n        this._renderer = null;\r\n      }\r\n      if (this._scene) {\r\n        this._scene.clear();\r\n        this._scene = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Ê≥®ÂÜå‰∏ªÂç°ÁâáÔºàÈò≤Ê≠¢ÈáçÂ§çÊ≥®ÂÜåÔºâ\r\n  if (!customElements.get('ha-reachy-mini-card')) {\r\n    customElements.define('ha-reachy-mini-card', ReachyMini3DCard);\r\n  }\r\n\r\n  // Ê≥®ÂÜåÂà∞ window.customCards ‰ª•‰æøÂú®Âç°ÁâáÈÄâÊã©Âô®‰∏≠ÊòæÁ§∫\r\n  window.customCards = window.customCards || [];\r\n  window.customCards.push({\r\n    type: 'ha-reachy-mini-card',\r\n    name: 'Reachy Mini 3D Card',\r\n    description: '3D visualization of Reachy Mini robot',\r\n    preview: true,\r\n    documentationURL: 'https://github.com/Desmond-Dong/ha-reachy-mini-card',\r\n  });\r\n\r\n})();"],"names":["PASSIVE_JOINT_NAMES","ReachyMini3DCardEditor","HTMLElement","constructor","super","this","attachShadow","mode","setConfig","config","_config","render","shadowRoot","innerHTML","daemon_host","daemon_port","height","background_color","camera_distance","enable_passive_joints","enable_head_pose","enable_grid","getElementById","addEventListener","e","target","value","dispatchConfig","parseInt","parseFloat","checked","event","CustomEvent","detail","bubbles","composed","dispatchEvent","customElements","get","define","ReachyMini3DCard","_frameCount","_lastDataVersion","_robotState","headJoints","headPose","passiveJoints","antennas","dataVersion","_reconnectAttempts","_maxReconnectAttempts","_reconnectDelay","_reconnectTimeout","getConfigElement","document","createElement","getStubConfig","getCardSize","getGridOptions","rows","Math","ceil","columns","min_rows","max_rows","hass","_hass","connectedCallback","init","loadThreeJS","_setupScene","loadRobot","startPolling","err","console","error","showError","message","basePath","getBasePath","THREE","WebGLRenderer","log","threeModule","import","window","orbitControlsModule","OrbitControls","default","Error","apiUrl","_pollingInterval","setInterval","async","response","fetch","ok","data","json","_processRobotData","updateStatus","status","head_joints","Array","isArray","length","undefined","body_yaw","head_pose","antennas_position","passive_joints","_updateRobot","_robot","joints","setJointValue","forEach","name","i","jointName","loader","URDFLoader","workingPath","load","_scene","add","_initializeJoints","loading","querySelector","style","display","_startAnimationLoop","container","canvas","width","appendChild","Scene","background","Color","_camera","PerspectiveCamera","clientWidth","position","set","_renderer","antialias","setSize","setPixelRatio","min","devicePixelRatio","_controls","enableDamping","dampingFactor","minDistance","maxDistance","AmbientLight","directionalLight","DirectionalLight","backLight","GridHelper","_fpsCounter","frameCount","lastTime","performance","now","fps","animate","_animationId","requestAnimationFrame","currentTime","fpsEl","textContent","update","statusEl","className","disconnectedCallback","cancelAnimationFrame","clearInterval","dispose","clear","customCards","push","type","description","preview","documentationURL"],"mappings":"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"}