{"version":3,"file":"reachy-mini-3d-card.js","sources":["src/reachy-mini-3d-card.js"],"sourcesContent":["// Reachy Mini 3D Card - Direct Daemon Connection\n// Home Assistant Lovelace Custom Card\n\n// 注册 custom card\nwindow.customCards = window.customCards || [];\nwindow.customCards.push({\n  type: 'reachy-mini-3d-card',\n  name: 'Reachy Mini 3D Card',\n  description: 'Real-time 3D visualization of Reachy Mini robot',\n  preview: true,\n  documentationURL: 'https://github.com/Desmond-Dong/ha-reachy-mini-card'\n});\n\nclass ReachyMini3DCard extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: 'open' });\n  }\n\n  setConfig(config) {\n    this._config = {\n      daemon_host: 'localhost',\n      daemon_port: 3333,\n      height: 400,\n      ...config\n    };\n  }\n\n  getCardSize() {\n    return this._config.height ? this._config.height / 50 : 8;\n  }\n\n  async connectedCallback() {\n    this.render();\n    await this.init();\n  }\n\n  render() {\n    this.shadowRoot.innerHTML = `\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n      </style>\n      <ha-card>\n        <div id=\"container\">\n          <div id=\"status\" class=\"connecting\">Connecting...</div>\n          <div id=\"loading\" class=\"loading\">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `;\n  }\n\n  async init() {\n    try {\n      // 加载依赖\n      await this.loadScripts();\n\n      // 初始化 Three.js\n      this.initThreeJS();\n\n      // 连接 WebSocket\n      this.connectWebSocket();\n\n      // 加载机器人模型\n      this.loadRobot();\n\n    } catch (err) {\n      console.error('Init error:', err);\n      this.showError(err.message);\n    }\n  }\n\n  async loadScripts() {\n    const load = (src) => new Promise((resolve, reject) => {\n      if (document.querySelector(`script[src=\"${src}\"]`)) return resolve();\n      const script = document.createElement('script');\n      script.src = src;\n      script.onload = resolve;\n      script.onerror = () => reject(new Error(`Failed to load ${src}`));\n      document.head.appendChild(script);\n    });\n\n    if (!window.THREE) await load('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js');\n    await load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js');\n    await load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js');\n  }\n\n  initThreeJS() {\n    const container = this.shadowRoot.querySelector('#container');\n    const canvas = document.createElement('canvas');\n    container.appendChild(canvas);\n\n    // 场景\n    this._scene = new THREE.Scene();\n    this._scene.background = new THREE.Color(0xf5f5f5);\n\n    // 相机\n    this._camera = new THREE.PerspectiveCamera(50, container.clientWidth / this._config.height, 0.01, 1000);\n    this._camera.position.set(0.3, 0.3, 0.5);\n\n    // 渲染器\n    this._renderer = new THREE.WebGLRenderer({ canvas, antialias: true });\n    this._renderer.setSize(container.clientWidth, this._config.height);\n    this._renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n\n    // 控制器\n    this._controls = new THREE.OrbitControls(this._camera, canvas);\n    this._controls.enableDamping = true;\n    this._controls.minDistance = 0.2;\n    this._controls.maxDistance = 1.0;\n\n    // 灯光\n    this._scene.add(new THREE.AmbientLight(0xffffff, 0.6));\n    const light = new THREE.DirectionalLight(0xffffff, 0.8);\n    light.position.set(1, 1, 1);\n    this._scene.add(light);\n\n    // 地面网格\n    this._scene.add(new THREE.GridHelper(0.4, 20, 0x888888, 0xcccccc));\n\n    // 动画循环\n    const animate = () => {\n      requestAnimationFrame(animate);\n      this._controls.update();\n      this._renderer.render(this._scene, this._camera);\n    };\n    animate();\n  }\n\n  async loadRobot() {\n    const basePath = this.getBasePath();\n    const { default: URDFLoader } = await import(`${basePath}lib/urdf-loader.js`);\n\n    const loader = new URDFLoader();\n    loader.workingPath = `${basePath}assets/`;\n\n    this._robot = await loader.load(`${basePath}assets/reachy-mini.urdf`);\n    this._scene.add(this._robot);\n\n    // 隐藏加载动画\n    const loading = this.shadowRoot.querySelector('#loading');\n    if (loading) loading.style.display = 'none';\n  }\n\n  getBasePath() {\n    const scripts = document.getElementsByTagName('script');\n    const src = scripts[scripts.length - 1]?.src || '';\n    return src ? src.substring(0, src.lastIndexOf('/') + 1) : '/hacsfiles/reachy-mini-3d-card/';\n  }\n\n  connectWebSocket() {\n    const { daemon_host, daemon_port } = this._config;\n    const url = `ws://${daemon_host}:${daemon_port}/api/state/ws/full?frequency=20&with_head_joints=true&with_antenna_positions=true`;\n\n    this._ws = new WebSocket(url);\n\n    this._ws.onopen = () => {\n      this.updateStatus('connected', 'Connected');\n    };\n\n    this._ws.onmessage = (e) => {\n      try {\n        const data = JSON.parse(e.data);\n        this.updateRobot(data);\n      } catch (err) {\n        console.error('Parse error:', err);\n      }\n    };\n\n    this._ws.onerror = () => this.updateStatus('error', 'Error');\n    this._ws.onclose = () => {\n      this.updateStatus('error', 'Disconnected');\n      setTimeout(() => this.connectWebSocket(), 3000);\n    };\n  }\n\n  updateRobot(data) {\n    if (!this._robot) return;\n\n    if (data.head_joints?.length === 7) {\n      const j = data.head_joints;\n      this._robot.setJointValue('yaw_body', j[0]);\n      this._robot.setJointValue('stewart_1', j[1]);\n      this._robot.setJointValue('stewart_2', j[2]);\n      this._robot.setJointValue('stewart_3', j[3]);\n      this._robot.setJointValue('stewart_4', j[4]);\n      this._robot.setJointValue('stewart_5', j[5]);\n      this._robot.setJointValue('stewart_6', j[6]);\n    }\n\n    if (data.antennas_position?.length === 2) {\n      this._robot.setJointValue('left_antenna', -data.antennas_position[0]);\n      this._robot.setJointValue('right_antenna', -data.antennas_position[1]);\n    }\n  }\n\n  updateStatus(state, msg) {\n    const el = this.shadowRoot.querySelector('#status');\n    if (el) {\n      el.className = state;\n      el.textContent = msg;\n    }\n  }\n\n  showError(msg) {\n    this.shadowRoot.querySelector('#container').innerHTML = `\n      <div style=\"padding: 20px; color: #f44336;\">Error: ${msg}</div>\n    `;\n  }\n\n  disconnectedCallback() {\n    if (this._ws) this._ws.close();\n    if (this._renderer) this._renderer.dispose();\n  }\n}\n\ncustomElements.define('reachy-mini-3d-card', ReachyMini3DCard);\n"],"names":["window","customCards","push","type","name","description","preview","documentationURL","ReachyMini3DCard","HTMLElement","constructor","super","this","attachShadow","mode","setConfig","config","_config","daemon_host","daemon_port","height","getCardSize","connectedCallback","render","init","shadowRoot","innerHTML","loadScripts","initThreeJS","connectWebSocket","loadRobot","err","console","error","showError","message","load","src","Promise","resolve","reject","document","querySelector","script","createElement","onload","onerror","Error","head","appendChild","THREE","container","canvas","_scene","Scene","background","Color","_camera","PerspectiveCamera","clientWidth","position","set","_renderer","WebGLRenderer","antialias","setSize","setPixelRatio","Math","min","devicePixelRatio","_controls","OrbitControls","enableDamping","minDistance","maxDistance","add","AmbientLight","light","DirectionalLight","GridHelper","animate","requestAnimationFrame","update","basePath","getBasePath","default","URDFLoader","import","loader","workingPath","_robot","loading","style","display","scripts","getElementsByTagName","length","substring","lastIndexOf","url","_ws","WebSocket","onopen","updateStatus","onmessage","e","data","JSON","parse","updateRobot","onclose","setTimeout","head_joints","j","setJointValue","antennas_position","state","msg","el","className","textContent","disconnectedCallback","close","dispose","customElements","define"],"mappings":"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"}