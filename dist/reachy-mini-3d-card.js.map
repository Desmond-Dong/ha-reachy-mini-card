{"version":3,"file":"reachy-mini-3d-card.js","sources":["../src/reachy-mini-3d-card.js"],"sourcesContent":["// Reachy Mini 3D Card - Direct Daemon Connection\r\n// Home Assistant Lovelace Custom Card\r\n\r\n// 注册 custom card\r\nwindow.customCards = window.customCards || [];\r\nwindow.customCards.push({\r\n  type: 'reachy-mini-3d-card',\r\n  name: 'Reachy Mini 3D Card',\r\n  description: 'Real-time 3D visualization of Reachy Mini robot',\r\n  preview: true,\r\n  documentationURL: 'https://github.com/Desmond-Dong/ha-reachy-mini-card'\r\n});\r\n\r\nclass ReachyMini3DCard extends HTMLElement {\r\n  constructor() {\r\n    super();\r\n    this.attachShadow({ mode: 'open' });\r\n  }\r\n\r\n  setConfig(config) {\r\n    this._config = {\r\n      daemon_host: 'localhost',\r\n      daemon_port: 3333,\r\n      height: 400,\r\n      ...config\r\n    };\r\n  }\r\n\r\n  getCardSize() {\r\n    return this._config.height ? this._config.height / 50 : 8;\r\n  }\r\n\r\n  async connectedCallback() {\r\n    this.render();\r\n    await this.init();\r\n  }\r\n\r\n  render() {\r\n    this.shadowRoot.innerHTML = `\r\n      <style>\r\n        :host { display: block; }\r\n        ha-card {\r\n          overflow: hidden;\r\n          border-radius: var(--ha-card-border-radius, 12px);\r\n          box-shadow: var(--ha-card-box-shadow, none);\r\n        }\r\n        #container {\r\n          position: relative;\r\n          width: 100%;\r\n          height: ${this._config.height}px;\r\n        }\r\n        #status {\r\n          position: absolute;\r\n          top: 10px;\r\n          left: 10px;\r\n          padding: 6px 12px;\r\n          border-radius: 20px;\r\n          font-size: 12px;\r\n          font-weight: 500;\r\n          color: white;\r\n          z-index: 10;\r\n        }\r\n        .connected { background: #4caf50; }\r\n        .connecting { background: #ff9800; }\r\n        .error { background: #f44336; }\r\n        .loading {\r\n          position: absolute;\r\n          top: 50%;\r\n          left: 50%;\r\n          transform: translate(-50%, -50%);\r\n        }\r\n      </style>\r\n      <ha-card>\r\n        <div id=\"container\">\r\n          <div id=\"status\" class=\"connecting\">Connecting...</div>\r\n          <div id=\"loading\" class=\"loading\">\r\n            <ha-circular-progress indeterminate></ha-circular-progress>\r\n          </div>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n  }\r\n\r\n  async init() {\r\n    try {\r\n      // 加载依赖\r\n      await this.loadScripts();\r\n\r\n      // 初始化 Three.js\r\n      this.initThreeJS();\r\n\r\n      // 连接 WebSocket\r\n      this.connectWebSocket();\r\n\r\n      // 加载机器人模型\r\n      this.loadRobot();\r\n\r\n    } catch (err) {\r\n      console.error('Init error:', err);\r\n      this.showError(err.message);\r\n    }\r\n  }\r\n\r\n  async loadScripts() {\r\n    const load = (src) => new Promise((resolve, reject) => {\r\n      if (document.querySelector(`script[src=\"${src}\"]`)) return resolve();\r\n      const script = document.createElement('script');\r\n      script.src = src;\r\n      script.onload = resolve;\r\n      script.onerror = () => reject(new Error(`Failed to load ${src}`));\r\n      document.head.appendChild(script);\r\n    });\r\n\r\n    if (!window.THREE) await load('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js');\r\n    await load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js');\r\n    await load('https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js');\r\n  }\r\n\r\n  initThreeJS() {\r\n    const container = this.shadowRoot.querySelector('#container');\r\n    const canvas = document.createElement('canvas');\r\n    container.appendChild(canvas);\r\n\r\n    // 场景\r\n    this._scene = new THREE.Scene();\r\n    this._scene.background = new THREE.Color(0xf5f5f5);\r\n\r\n    // 相机\r\n    this._camera = new THREE.PerspectiveCamera(50, container.clientWidth / this._config.height, 0.01, 1000);\r\n    this._camera.position.set(0.3, 0.3, 0.5);\r\n\r\n    // 渲染器\r\n    this._renderer = new THREE.WebGLRenderer({ canvas, antialias: true });\r\n    this._renderer.setSize(container.clientWidth, this._config.height);\r\n    this._renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\r\n\r\n    // 控制器\r\n    this._controls = new THREE.OrbitControls(this._camera, canvas);\r\n    this._controls.enableDamping = true;\r\n    this._controls.minDistance = 0.2;\r\n    this._controls.maxDistance = 1.0;\r\n\r\n    // 灯光\r\n    this._scene.add(new THREE.AmbientLight(0xffffff, 0.6));\r\n    const light = new THREE.DirectionalLight(0xffffff, 0.8);\r\n    light.position.set(1, 1, 1);\r\n    this._scene.add(light);\r\n\r\n    // 地面网格\r\n    this._scene.add(new THREE.GridHelper(0.4, 20, 0x888888, 0xcccccc));\r\n\r\n    // 动画循环\r\n    const animate = () => {\r\n      requestAnimationFrame(animate);\r\n      this._controls.update();\r\n      this._renderer.render(this._scene, this._camera);\r\n    };\r\n    animate();\r\n  }\r\n\r\n  async loadRobot() {\r\n    const basePath = this.getBasePath();\r\n    const { default: URDFLoader } = await import(`${basePath}lib/urdf-loader.js`);\r\n\r\n    const loader = new URDFLoader();\r\n    loader.workingPath = `${basePath}assets/`;\r\n\r\n    this._robot = await loader.load(`${basePath}assets/reachy-mini.urdf`);\r\n    this._scene.add(this._robot);\r\n\r\n    // 隐藏加载动画\r\n    const loading = this.shadowRoot.querySelector('#loading');\r\n    if (loading) loading.style.display = 'none';\r\n  }\r\n\r\n  getBasePath() {\r\n    const scripts = document.getElementsByTagName('script');\r\n    const src = scripts[scripts.length - 1]?.src || '';\r\n    return src ? src.substring(0, src.lastIndexOf('/') + 1) : '/hacsfiles/reachy-mini-3d-card/';\r\n  }\r\n\r\n  connectWebSocket() {\r\n    const { daemon_host, daemon_port } = this._config;\r\n    const url = `ws://${daemon_host}:${daemon_port}/api/state/ws/full?frequency=20&with_head_joints=true&with_antenna_positions=true`;\r\n\r\n    this._ws = new WebSocket(url);\r\n\r\n    this._ws.onopen = () => {\r\n      this.updateStatus('connected', 'Connected');\r\n    };\r\n\r\n    this._ws.onmessage = (e) => {\r\n      try {\r\n        const data = JSON.parse(e.data);\r\n        this.updateRobot(data);\r\n      } catch (err) {\r\n        console.error('Parse error:', err);\r\n      }\r\n    };\r\n\r\n    this._ws.onerror = () => this.updateStatus('error', 'Error');\r\n    this._ws.onclose = () => {\r\n      this.updateStatus('error', 'Disconnected');\r\n      setTimeout(() => this.connectWebSocket(), 3000);\r\n    };\r\n  }\r\n\r\n  updateRobot(data) {\r\n    if (!this._robot) return;\r\n\r\n    if (data.head_joints?.length === 7) {\r\n      const j = data.head_joints;\r\n      this._robot.setJointValue('yaw_body', j[0]);\r\n      this._robot.setJointValue('stewart_1', j[1]);\r\n      this._robot.setJointValue('stewart_2', j[2]);\r\n      this._robot.setJointValue('stewart_3', j[3]);\r\n      this._robot.setJointValue('stewart_4', j[4]);\r\n      this._robot.setJointValue('stewart_5', j[5]);\r\n      this._robot.setJointValue('stewart_6', j[6]);\r\n    }\r\n\r\n    if (data.antennas_position?.length === 2) {\r\n      this._robot.setJointValue('left_antenna', -data.antennas_position[0]);\r\n      this._robot.setJointValue('right_antenna', -data.antennas_position[1]);\r\n    }\r\n  }\r\n\r\n  updateStatus(state, msg) {\r\n    const el = this.shadowRoot.querySelector('#status');\r\n    if (el) {\r\n      el.className = state;\r\n      el.textContent = msg;\r\n    }\r\n  }\r\n\r\n  showError(msg) {\r\n    this.shadowRoot.querySelector('#container').innerHTML = `\r\n      <div style=\"padding: 20px; color: #f44336;\">Error: ${msg}</div>\r\n    `;\r\n  }\r\n\r\n  disconnectedCallback() {\r\n    if (this._ws) this._ws.close();\r\n    if (this._renderer) this._renderer.dispose();\r\n  }\r\n}\r\n\r\ncustomElements.define('reachy-mini-3d-card', ReachyMini3DCard);\r\n"],"names":["window","customCards","push","type","name","description","preview","documentationURL","ReachyMini3DCard","HTMLElement","constructor","super","this","attachShadow","mode","setConfig","config","_config","daemon_host","daemon_port","height","getCardSize","connectedCallback","render","init","shadowRoot","innerHTML","loadScripts","initThreeJS","connectWebSocket","loadRobot","err","console","error","showError","message","load","src","Promise","resolve","reject","document","querySelector","script","createElement","onload","onerror","Error","head","appendChild","THREE","container","canvas","_scene","Scene","background","Color","_camera","PerspectiveCamera","clientWidth","position","set","_renderer","WebGLRenderer","antialias","setSize","setPixelRatio","Math","min","devicePixelRatio","_controls","OrbitControls","enableDamping","minDistance","maxDistance","add","AmbientLight","light","DirectionalLight","GridHelper","animate","requestAnimationFrame","update","basePath","getBasePath","default","URDFLoader","import","loader","workingPath","_robot","loading","style","display","scripts","getElementsByTagName","length","substring","lastIndexOf","url","_ws","WebSocket","onopen","updateStatus","onmessage","e","data","JSON","parse","updateRobot","onclose","setTimeout","head_joints","j","setJointValue","antennas_position","state","msg","el","className","textContent","disconnectedCallback","close","dispose","customElements","define"],"mappings":"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"}