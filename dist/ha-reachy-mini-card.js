!function(){"use strict";!function(){const t=["passive_1_x","passive_1_y","passive_1_z","passive_2_x","passive_2_y","passive_2_z","passive_3_x","passive_3_y","passive_3_z","passive_4_x","passive_4_y","passive_4_z","passive_5_x","passive_5_y","passive_5_z","passive_6_x","passive_6_y","passive_6_z","passive_7_x","passive_7_y","passive_7_z"];class e extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}setConfig(t){this._config=t,this.render()}render(){const t=this._config||{};this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        .form-row {\n          display: flex;\n          flex-direction: column;\n          margin-bottom: 12px;\n        }\n        label {\n          font-size: 14px;\n          font-weight: 500;\n          margin-bottom: 4px;\n          color: var(--primary-text-color);\n        }\n        input[type="text"],\n        input[type="number"] {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid var(--primary-color);\n          border-radius: 4px;\n          background: var(--card-background-color);\n          color: var(--primary-text-color);\n          box-sizing: border-box;\n        }\n        input[type="text"]:focus,\n        input[type="number"]:focus {\n          outline: none;\n          border-color: var(--accent-color);\n        }\n        .checkbox-row {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          margin-bottom: 8px;\n        }\n        .checkbox-row input[type="checkbox"] {\n          width: auto;\n          margin: 0;\n        }\n        .checkbox-row label {\n          margin-bottom: 0;\n          flex: 1;\n        }\n        .hint {\n          font-size: 12px;\n          color: var(--secondary-text-color);\n          margin-top: 4px;\n        }\n        .section-title {\n          font-size: 13px;\n          font-weight: 600;\n          color: var(--primary-text-color);\n          margin-top: 16px;\n          margin-bottom: 8px;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n        }\n      </style>\n\n      <div class="section-title">Connection</div>\n\n      <div class="form-row">\n        <label for="host">Daemon Host</label>\n        <input\n          id="host"\n          type="text"\n          value="${t.daemon_host||"localhost"}"\n          placeholder="localhost or IP address"\n        />\n        <div class="hint">Reachy Mini daemon hostname or IP address</div>\n      </div>\n\n      <div class="form-row">\n        <label for="port">Daemon Port</label>\n        <input\n          id="port"\n          type="number"\n          value="${t.daemon_port||8e3}"\n          placeholder="8000"\n        />\n        <div class="hint">WebSocket port (default: 8000)</div>\n      </div>\n\n      <div class="section-title">Display</div>\n\n      <div class="form-row">\n        <label for="height">Card Height (px)</label>\n        <input\n          id="height"\n          type="number"\n          value="${t.height||400}"\n          placeholder="400"\n        />\n        <div class="hint">Height of the card in pixels</div>\n      </div>\n\n      <div class="form-row">\n        <label for="background">Background Color</label>\n        <input\n          id="background"\n          type="text"\n          value="${t.background_color||"#f5f5f5"}"\n          placeholder="#f5f5f5"\n        />\n        <div class="hint">Background color (hex code)</div>\n      </div>\n\n      <div class="form-row">\n        <label for="camera_distance">Camera Distance</label>\n        <input\n          id="camera_distance"\n          type="number"\n          step="0.1"\n          value="${t.camera_distance||.5}"\n          placeholder="0.5"\n        />\n        <div class="hint">Initial camera distance (0.2 - 1.5)</div>\n      </div>\n\n      <div class="section-title">Features</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_passive" ${!1!==t.enable_passive_joints?"checked":""}>\n        <label for="enable_passive">Enable Passive Joints</label>\n      </div>\n      <div class="hint">Show Stewart platform passive joints (requires daemon support)</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_pose" ${!1!==t.enable_head_pose?"checked":""}>\n        <label for="enable_pose">Enable Head Pose</label>\n      </div>\n      <div class="hint">Use 4x4 pose matrix for head positioning</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_grid" ${!1!==t.enable_grid?"checked":""}>\n        <label for="enable_grid">Show Grid</label>\n      </div>\n      <div class="hint">Display ground grid helper</div>\n    `,this.shadowRoot.getElementById("host").addEventListener("change",t=>{this._config={...this._config,daemon_host:t.target.value},this.dispatchConfig()}),this.shadowRoot.getElementById("port").addEventListener("change",t=>{this._config={...this._config,daemon_port:parseInt(t.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("height").addEventListener("change",t=>{this._config={...this._config,height:parseInt(t.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("background").addEventListener("change",t=>{this._config={...this._config,background_color:t.target.value},this.dispatchConfig()}),this.shadowRoot.getElementById("camera_distance").addEventListener("change",t=>{this._config={...this._config,camera_distance:parseFloat(t.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_passive").addEventListener("change",t=>{this._config={...this._config,enable_passive_joints:t.target.checked},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_pose").addEventListener("change",t=>{this._config={...this._config,enable_head_pose:t.target.checked},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_grid").addEventListener("change",t=>{this._config={...this._config,enable_grid:t.target.checked},this.dispatchConfig()})}dispatchConfig(){const t=new CustomEvent("config-changed",{detail:{config:this._config},bubbles:!0,composed:!0});this.dispatchEvent(t)}}customElements.define("ha-reachy-mini-card-editor",e);class n extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._frameCount=0,this._lastDataVersion=-1,this._robotState={headJoints:null,headPose:null,passiveJoints:null,antennas:[0,0],dataVersion:0},this._reconnectAttempts=0,this._maxReconnectAttempts=10,this._reconnectDelay=3e3,this._reconnectTimeout=null}static getConfigElement(){return document.createElement("ha-reachy-mini-card-editor")}static getStubConfig(){return{daemon_host:"localhost",daemon_port:8e3,height:400,enable_passive_joints:!0,enable_head_pose:!0,background_color:"#f5f5f5",enable_grid:!0,camera_distance:.5}}setConfig(t){this._config={daemon_host:"localhost",daemon_port:8e3,height:400,enable_passive_joints:!0,enable_head_pose:!0,background_color:"#f5f5f5",enable_grid:!0,camera_distance:.5,...t}}getCardSize(){return this._config.height?this._config.height/50:8}getGridOptions(){const t=this._config.height||400;return{rows:Math.ceil(t/50),columns:6,min_rows:4,max_rows:20}}set hass(t){this._hass=t}async connectedCallback(){this.render(),await this.init()}render(){this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n          transition: all 0.3s ease;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n        #fps-counter {\n          position: absolute;\n          top: 10px;\n          right: 10px;\n          padding: 4px 8px;\n          border-radius: 12px;\n          font-size: 11px;\n          font-weight: 500;\n          color: white;\n          background: rgba(0, 0, 0, 0.6);\n          z-index: 10;\n        }\n      </style>\n      <ha-card>\n        <div id="container">\n          <div id="status" class="connecting">Connecting...</div>\n          <div id="fps-counter">0 FPS</div>\n          <div id="loading" class="loading">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `}async init(){try{await this.loadThreeJS(),this._setupScene(),await this.loadRobot(),this.startPolling()}catch(t){console.error("Init error:",t),this.showError(t.message)}}async loadThreeJS(){const t=this.getBasePath();if("undefined"!=typeof THREE&&THREE)console.log("âœ… Three.js already loaded");else{console.log("ðŸ“¦ Loading Three.js from lib/three.module.js...");try{const e=await import(`${t}lib/three.module.js`);window.THREE=e,console.log("âœ… Three.js loaded");const n=await import(`${t}lib/OrbitControls.js`);window.OrbitControls=n.OrbitControls||n.default,console.log("âœ… OrbitControls loaded")}catch(t){throw console.error("âŒ Failed to load Three.js:",t),new Error("Failed to load Three.js: "+t.message)}}}startPolling(){const{daemon_host:t,daemon_port:e}=this._config,n=`http://${t}:${e}/api/state/full?with_control_mode=true&with_head_joints=true&with_body_yaw=true&with_antenna_positions=true&with_passive_joints=true`;console.log("ðŸ”„ Starting polling:",n),this._pollingInterval=setInterval(async()=>{try{const t=await fetch(n);if(t.ok){const e=await t.json();this._processRobotData(e),this.updateStatus("connected","Connected")}else console.error("âŒ API error:",t.status),this.updateStatus("error",`Error: ${t.status}`)}catch(t){console.error("âŒ Polling error:",t),this.updateStatus("error","Connection Failed")}},50)}_processRobotData(t){t.head_joints&&Array.isArray(t.head_joints)&&t.head_joints.length>=7&&(this._robotState.headJoints=t.head_joints),void 0!==t.body_yaw&&(this._robotState.headJoints||(this._robotState.headJoints=[]),this._robotState.headJoints[0]=t.body_yaw),t.head_pose&&(this._robotState.headPose=t.head_pose),t.antennas_position&&Array.isArray(t.antennas_position)&&t.antennas_position.length>=2&&(this._robotState.antennas=t.antennas_position),t.passive_joints&&Array.isArray(t.passive_joints)&&t.passive_joints.length>=21&&(this._robotState.passiveJoints=t.passive_joints),this._robotState.dataVersion++,this._updateRobot()}_updateRobot(){if(this._robot){if(this._robotState.headJoints){const t=this._robotState.headJoints;this._robot.joints.yaw_body&&this._robot.setJointValue("yaw_body",t[0]),["stewart_1","stewart_2","stewart_3","stewart_4","stewart_5","stewart_6"].forEach((e,n)=>{this._robot.joints[e]&&this._robot.setJointValue(e,t[n+1])})}if(!1!==this._config.enable_passive_joints&&this._robotState.passiveJoints){const e=this._robotState.passiveJoints;for(let n=0;n<21;n++){const o=t[n];this._robot.joints[o]&&this._robot.setJointValue(o,e[n])}}if(this._robotState.antennas){const t=this._robotState.antennas;this._robot.joints.left_antenna&&this._robot.setJointValue("left_antenna",-t[1]),this._robot.joints.right_antenna&&this._robot.setJointValue("right_antenna",-t[0])}}}async loadRobot(){const t=this.getBasePath();await import(`${t}lib/URDFClasses.js`),await import(`${t}lib/URDFDragControls.js`);const e=new(0,(await import(`${t}lib/urdf-loader.js`)).default);e.workingPath=`${t}assets/`,this._robot=await e.load(`${t}assets/reachy-mini.urdf`),this._scene.add(this._robot),this._initializeJoints();const n=this.shadowRoot.querySelector("#loading");n&&(n.style.display="none"),this._startAnimationLoop()}_initializeJoints(){this._robot&&this._robot.joints&&(this._robot.joints.yaw_body&&this._robot.setJointValue("yaw_body",0),["stewart_1","stewart_2","stewart_3","stewart_4","stewart_5","stewart_6"].forEach(t=>{this._robot.joints[t]&&this._robot.setJointValue(t,0)}),t.forEach(t=>{this._robot.joints[t]&&this._robot.setJointValue(t,0)}),["left_antenna","right_antenna"].forEach(t=>{this._robot.joints[t]&&this._robot.setJointValue(t,0)}))}_setupScene(){const t=this.shadowRoot.querySelector("#container"),e=document.createElement("canvas");e.style.width="100%",e.style.height="100%",t.appendChild(e),this._scene=new THREE.Scene,this._scene.background=new THREE.Color(this._config.background_color||"#f5f5f5"),this._camera=new THREE.PerspectiveCamera(50,t.clientWidth/this._config.height,.01,1e3),this._camera.position.set(.3,.3,this._config.camera_distance||.5),this._renderer=new THREE.WebGLRenderer({canvas:e,antialias:!0}),this._renderer.setSize(t.clientWidth,this._config.height),this._renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this._controls=new OrbitControls(this._camera,e),this._controls.enableDamping=!0,this._controls.dampingFactor=.05,this._controls.minDistance=.2,this._controls.maxDistance=1.5,this._controls.target.set(0,.15,0),this._scene.add(new THREE.AmbientLight(16777215,.6));const n=new THREE.DirectionalLight(16777215,.8);n.position.set(1,1,1),this._scene.add(n);const o=new THREE.DirectionalLight(16777215,.3);o.position.set(-1,-1,-1),this._scene.add(o),!1!==this._config.enable_grid&&this._scene.add(new THREE.GridHelper(.4,20,8947848,13421772)),this._fpsCounter={frameCount:0,lastTime:performance.now(),fps:0}}_startAnimationLoop(){const t=()=>{this._animationId=requestAnimationFrame(t),this._updateRobot(),this._fpsCounter.frameCount++;const e=performance.now();if(e-this._fpsCounter.lastTime>=1e3){this._fpsCounter.fps=this._fpsCounter.frameCount,this._fpsCounter.frameCount=0,this._fpsCounter.lastTime=e;const t=this.shadowRoot.querySelector("#fps-counter");t&&(t.textContent=`${this._fpsCounter.fps} FPS`)}this._controls.update(),this._renderer.render(this._scene,this._camera)};t()}updateStatus(t,e){const n=this.shadowRoot.querySelector("#status");n&&(n.className=t,n.textContent=e)}showError(t){const e=this.shadowRoot.querySelector("#container");e&&(e.innerHTML=`\n          <div style="padding: 20px; color: #f44336;">Error: ${t}</div>\n        `)}getBasePath(){return"/hacsfiles/ha-reachy-mini-card/"}disconnectedCallback(){this._animationId&&(cancelAnimationFrame(this._animationId),this._animationId=null),this._pollingInterval&&(clearInterval(this._pollingInterval),this._pollingInterval=null),this._renderer&&(this._renderer.dispose(),this._renderer=null),this._scene&&(this._scene.clear(),this._scene=null)}}customElements.define("ha-reachy-mini-card",n),window.customCards=window.customCards||[],window.customCards.push({type:"ha-reachy-mini-card",name:"Reachy Mini 3D Card",description:"3D visualization of Reachy Mini robot",preview:!0,documentationURL:"https://github.com/Desmond-Dong/ha-reachy-mini-card"})}()}();
//# sourceMappingURL=ha-reachy-mini-card.js.map
